<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Pontos de √°gua ICNF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <style>
    html, body, #viewDiv {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* Pain√©is redesenhados para mobile */
    #infoPanel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-height: 30%;
      overflow-y: auto;
      z-index: 10;
      display: block;
      -webkit-overflow-scrolling: touch;
    }
    
    #togglePanel {
      position: absolute;
      top: 70px;
      right: 15px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      z-index: 10;
      border: 1px solid #ddd;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      font-size: 16px;
    }
    
    #gpsButton {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #fff;
      padding: 10px;
      border-radius: 20px;
      z-index: 10;
      border: 1px solid #ddd;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    #loadingMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 80%;
      text-align: center;
    }
    
    .hidden {
      display: none !important;
    }
    
    .esri-popup__main-container {
      max-height: 50vh !important;
    }
    
    .popup-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .popup-table th, .popup-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
    }
    
    /* Melhorias para iOS */
    @supports (-webkit-touch-callout: none) {
      #infoPanel {
        padding-bottom: 20px; /* Evita o notch */
      }
    }
    
    /* Bot√µes de zoom */
    #zoomControls {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }
    
    .zoomButton {
      background: #fff;
      border: 1px solid #ddd;
      width: 40px;
      height: 40px;
      margin-bottom: 5px;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="infoPanel"></div>
  <div id="togglePanel">‚óÄ</div>
  <button id="gpsButton" title="Usar minha localiza√ß√£o">üìç</button>
  <div id="loadingMessage">Carregando dados WFS...</div>
  
  <!-- Controles de zoom -->
  <div id="zoomControls">
    <button class="zoomButton" id="zoomIn">+</button>
    <button class="zoomButton" id="zoomOut">-</button>
  </div>

  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/geometry/Polyline",
      "esri/geometry/geometryEngine",
      "esri/geometry/SpatialReference",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol",
      "esri/geometry/projection",
      "esri/widgets/Expand",
      "esri/widgets/Locate",
      "esri/widgets/BasemapToggle",
      "esri/widgets/BasemapGallery"
    ], function(
      Map, MapView, GraphicsLayer, Graphic, Point, Polyline,
      geometryEngine, SpatialReference, SimpleMarkerSymbol, SimpleLineSymbol,
      projection, Expand, Locate, BasemapToggle, BasemapGallery
    ) {

      // Configura√ß√£o do mapa mobile-friendly
      const map = new Map({
        basemap: "streets-navigation-vector"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-8, 39.5],
        zoom: 12,
        popupEnabled: true,
        ui: {
          components: ["attribution"]
        }
      });

      // Layers otimizados para mobile
      const pointsLayer = new GraphicsLayer();
      const linesLayer = new GraphicsLayer();
      const userLocationLayer = new GraphicsLayer();
      map.addMany([userLocationLayer, pointsLayer, linesLayer]);

      // Elementos UI
      const infoPanel = document.getElementById("infoPanel");
      const toggle = document.getElementById("togglePanel");
      const gpsButton = document.getElementById("gpsButton");
      const loadingMessage = document.getElementById("loadingMessage");
      const zoomInBtn = document.getElementById("zoomIn");
      const zoomOutBtn = document.getElementById("zoomOut");
      let allPoints = [], nearest = [];
      let watchHandler = null;

      // S√≠mbolos otimizados para mobile (tamanho reduzido)
      const waterPointSymbol = new SimpleMarkerSymbol({
        color: [0, 112, 255, 0.9],
        outline: {
          color: [255, 255, 255],
          width: 1.5
        },
        size: 8  // Reduzido de 10 para 8
      });

      const userLocationSymbol = new SimpleMarkerSymbol({
        color: [255, 0, 0, 0.9],
        outline: {
          color: [255, 255, 255],
          width: 2
        },
        size: 12  // Reduzido de 14 para 12
      });

      const lineSymbol = new SimpleLineSymbol({
        color: [255, 0, 0, 0.7],
        width: 2,
        style: "short-dash"
      });

      // Widget GPS integrado
      const locateWidget = new Locate({
        view: view,
        useHeadingEnabled: true,
        goToOverride: function(view, options) {
          options.target.scale = 2000; // N√≠vel de zoom quando encontra a localiza√ß√£o
          return view.goTo(options.target);
        }
      });
      view.ui.add(locateWidget, "top-left");

      // Widget para trocar mapas base
      const basemapGallery = new BasemapGallery({
        view: view
      });
      
      const bgExpand = new Expand({
        view: view,
        content: basemapGallery,
        expandIconClass: "esri-icon-basemap",
        expandTooltip: "Trocar mapa base"
      });
      view.ui.add(bgExpand, "top-right");

      // Controles de zoom
      zoomInBtn.addEventListener("click", () => {
        view.goTo({
          zoom: view.zoom + 1
        });
      });

      zoomOutBtn.addEventListener("click", () => {
        view.goTo({
          zoom: view.zoom - 1
        });
      });

      // GPS personalizado com watchPosition
      gpsButton.addEventListener("click", () => {
        if (navigator.geolocation) {
          if (watchHandler) {
            navigator.geolocation.clearWatch(watchHandler);
            watchHandler = null;
            userLocationLayer.removeAll();
            gpsButton.style.backgroundColor = "#fff";
          } else {
            gpsButton.style.backgroundColor = "#d4edff";
            watchHandler = navigator.geolocation.watchPosition(
              (position) => {
                const pt = new Point({
                  longitude: position.coords.longitude,
                  latitude: position.coords.latitude,
                  spatialReference: view.spatialReference
                });
                
                userLocationLayer.removeAll();
                userLocationLayer.add(new Graphic({
                  geometry: pt,
                  symbol: userLocationSymbol
                }));
                
                // Centraliza o mapa na posi√ß√£o
                view.goTo({
                  target: pt,
                  zoom: 14
                });
                
                // Encontra pontos pr√≥ximos
                findNearest(pt);
              },
              (error) => {
                console.error("Erro GPS:", error);
                alert("N√£o foi poss√≠vel obter a localiza√ß√£o: " + error.message);
              },
              {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 10000
              }
            );
          }
        } else {
          alert("Geolocaliza√ß√£o n√£o suportada pelo seu navegador");
        }
      });

      // Fun√ß√£o popup mobile-friendly
      function createPopupContent(attributes) {
        const validAttributes = Object.entries(attributes)
          .filter(([_, value]) => value !== null && value !== undefined && value !== "")
          .sort((a, b) => a[0].localeCompare(b[0]));
        
        let html = `<div class="popup-content"><table class="popup-table"><tbody>`;
        
        validAttributes.forEach(([key, value]) => {
          const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          html += `<tr><th>${formattedKey}</th><td>${value}</td></tr>`;
        });
        
        html += `</tbody></table></div>`;
        return html;
      }

      // Carregamento de dados
      const url = "https://si.icnf.pt/wfs/pontos_agua?service=WFS&version=2.0.0&request=GetFeature&typeNames=pontos_agua&outputFormat=application/json&srsName=EPSG:4258";

      projection.load().then(() => {
        fetch(url)
          .then(res => res.json())
          .then(geojson => {
            geojson.features.forEach(feat => {
              const [lon, lat] = feat.geometry.coordinates;
              const pt = new Point({
                longitude: lon,
                latitude: lat,
                spatialReference: new SpatialReference({ wkid: 4258 })
              });
              
              const projectedPt = projection.project(pt, view.spatialReference);
              
              const graphic = new Graphic({
                geometry: projectedPt,
                attributes: feat.properties,
                symbol: waterPointSymbol,
                popupTemplate: {
                  title: feat.properties.nome || "Ponto de √°gua",
                  content: createPopupContent(feat.properties)
                }
              });
              
              allPoints.push(graphic);
              pointsLayer.add(graphic);
            });
            loadingMessage.classList.add("hidden");
          })
          .catch(err => {
            console.error("Erro no carregamento WFS:", err);
            loadingMessage.textContent = "Erro no carregamento dos dados. Recarregue a p√°gina.";
          });
      });

      // Busca por pontos pr√≥ximos otimizada para mobile
      function findNearest(pt) {
        try {
          if (!allPoints.length) return;
          
          linesLayer.removeAll();
          
          const distances = allPoints.map(g => {
            const dist = geometryEngine.distance(pt, g.geometry, "meters");
            return { feature: g, distance: Math.round(dist) };
          });
          
          nearest = distances
            .filter(o => o.distance <= 5000) // 5km
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 4);

          nearest.forEach(item => {
            const line = new Polyline({
              paths: [[
                [pt.x, pt.y],
                [item.feature.geometry.x, item.feature.geometry.y]
              ]],
              spatialReference: view.spatialReference
            });
            
            linesLayer.add(new Graphic({
              geometry: line,
              symbol: lineSymbol
            }));
          });

          renderInfo();
        } catch (err) {
          console.error("Erro na busca:", err);
        }
      }

      // Visualiza√ß√£o de informa√ß√µes mobile
      function renderInfo() {
        let html = "<h3 style='margin-top:0'>Pontos pr√≥ximos (at√© 5km):</h3>";
        if (!nearest.length) {
          html += "<p>Nenhum ponto encontrado.</p>";
        } else {
          html += "<ul style='padding-left:20px'>";
          nearest.forEach(o => {
            const a = o.feature.attributes;
            const name = a.nome || "Sem nome";
            const type = a.tipologia ? ` (${a.tipologia})` : "";
            html += `<li style='margin-bottom:8px'><strong>${name}${type}</strong><br>${o.distance} metros</li>`;
          });
          html += "</ul>";
        }
        infoPanel.innerHTML = html;
      }

      // Gerenciamento de UI mobile
      toggle.addEventListener("click", () => {
        const isVisible = !infoPanel.classList.contains("hidden");
        infoPanel.classList.toggle("hidden");
        toggle.innerHTML = isVisible ? "Mostrar info ‚ñ≤" : "Ocultar ‚ñº";
      });

      // Toque no mapa para buscar
      view.on("click", (e) => {
        findNearest(e.mapPoint);
      });

      // Adapta o mapa √† orienta√ß√£o
      window.addEventListener("orientationchange", () => {
        setTimeout(() => view.resize(), 300);
      });
    });
  </script>
</body>
</html>