<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Pontos de água ICNF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<style>
html,body,#viewDiv{margin:0;padding:0;height:100%;width:100%}
#infoPanel{
  position:absolute;
  top:100px;
  right:10px;
  width:240px;
  background:#fff;
  padding:6px;
  border-radius:4px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  max-height:50%;
  overflow-y:auto;
  z-index:10;
  font-size:12px;
  transition:height .3s,opacity .3s
}
#minimizeInfo{
  position:absolute;
  top:4px;
  right:4px;
  background:#eee;
  border:none;
  cursor:pointer;
  border-radius:3px;
  padding:1px 4px;
  font-size:12px
}
#loadingMessage{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:15px;
  border-radius:6px;
  box-shadow:0 0 10px rgba(0,0,0,.2);
  z-index:1000;
  font-size:14px
}
#filterPanel{
  position:absolute;
  top:130px;
  left:10px;
  background:#fff;
  padding:6px;
  border-radius:4px;
  box-shadow:0 0 6px rgba(0,0,0,.2);
  z-index:10;
  width:200px;
  font-size:12px;
  transition:max-height .3s,opacity .3s;
  overflow:hidden
}
#minimizeFilter{
  width:100%;
  padding:4px;
  font-size:12px;
  background:#ddd;
  border:none;
  cursor:pointer;
  border-radius:3px;
  margin-bottom:4px
}
.hidden{display:none!important}
select,button{
  width:100%;
  padding:6px;
  margin:3px 0;
  box-sizing:border-box;
  font-size:12px
}
button{
  background-color:#0079c1;
  color:#fff;
  border:none;
  cursor:pointer
}
button:hover{background-color:#005a8c}
</style>
</head>
<body>
<div id="viewDiv"></div>

<div id="infoPanel">
  <button id="minimizeInfo">—</button>
  <div id="infoContent"></div>
</div>

<div id="filterPanel">
  <button id="minimizeFilter">Ocultar filtros</button>
  <strong>Filtrar por:</strong>
  <select id="distritoFilter"><option value="">Todos os distritos</option></select>
  <select id="concelhoFilter"><option value="">Todos os concelhos</option></select>
  <button id="applyFilter">Aplicar filtro</button>
  <button id="resetFilter">Repor filtros</button>
</div>

<div id="loadingMessage">A carregar dados WFS...</div>

<script src="https://js.arcgis.com/4.33/"></script>
<script>
require([
  "esri/Map","esri/views/MapView","esri/layers/GraphicsLayer","esri/Graphic",
  "esri/geometry/Point","esri/geometry/Polyline","esri/geometry/geometryEngine",
  "esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol",
  "esri/geometry/projection","esri/widgets/BasemapGallery","esri/widgets/Expand","esri/widgets/Search"
],function(Map,MapView,GraphicsLayer,Graphic,Point,Polyline,geometryEngine,
  SimpleMarkerSymbol,SimpleLineSymbol,projection,BasemapGallery,Expand,Search){

const map=new Map({basemap:"streets-navigation-vector"});
const view=new MapView({
  container:"viewDiv",
  map:map,
  center:[-8,39.5],
  zoom:7,
  popupEnabled:true
});

const pointsLayer=new GraphicsLayer(),
      linesLayer=new GraphicsLayer(),
      filteredPointsLayer=new GraphicsLayer(),
      locationLayer=new GraphicsLayer();
map.addMany([pointsLayer,linesLayer,filteredPointsLayer,locationLayer]);

const infoPanel=document.getElementById("infoPanel"),
      infoContent=document.getElementById("infoContent"),
      minimizeInfo=document.getElementById("minimizeInfo"),
      loadingMessage=document.getElementById("loadingMessage"),
      distritoFilter=document.getElementById("distritoFilter"),
      concelhoFilter=document.getElementById("concelhoFilter"),
      applyFilter=document.getElementById("applyFilter"),
      resetFilter=document.getElementById("resetFilter"),
      minimizeFilter=document.getElementById("minimizeFilter"),
      filterPanel=document.getElementById("filterPanel");

let allPoints=[],nearest=[],uniqueDistritos=new Set(),distritoConcelhoMap={};

const waterPointSymbol=new SimpleMarkerSymbol({color:[0,112,255,0.8],outline:{color:[100,255,255],width:1},size:6}),
      filteredPointSymbol=new SimpleMarkerSymbol({color:[255,0,0,0.8],outline:{color:[255,255,100],width:1},size:6}),
      locationSymbol=new SimpleMarkerSymbol({color:[0,255,0,0.8],outline:{color:[255,255,255],width:2},size:10}),
      lineSymbol=new SimpleLineSymbol({color:[255,0,0,0.6],width:1.5,style:"short-dash"});

view.when(()=>{
  const basemapGallery=new BasemapGallery({view:view});
  const bgExpand=new Expand({view:view,content:basemapGallery,expandIconClass:"esri-icon-basemap",expandTooltip:"Mudar mapa base"});
  view.ui.add(bgExpand,"bottom-right");

  const searchWidget=new Search({view:view});
  view.ui.add(searchWidget,{position:"top-right"});

  const locateBtn=document.createElement("button");
  locateBtn.innerHTML="📍";
  locateBtn.title="Localizar-me";
  locateBtn.style.cssText="width:auto;padding:6px;margin-left:5px;background:#fff;color:#000;border:1px solid #ccc;border-radius:4px;cursor:pointer";
  locateBtn.addEventListener("click",()=>manualLocate());
  view.ui.add(locateBtn,{position:"top-right"});
});

function manualLocate(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      setLocation(pos.coords.longitude,pos.coords.latitude);
    });
  }
}
function setLocation(lon,lat){
  locationLayer.removeAll();
  const point=new Point({longitude:lon,latitude:lat});
  view.goTo({target:point,zoom:14});
  locationLayer.add(new Graphic({geometry:point,symbol:locationSymbol}));
}

function createPopupContent(attrs){
  const valid=Object.entries(attrs).filter(([k,v])=>v!=null&&v!=="");
  valid.sort((a,b)=>a[0].localeCompare(b[0]));
  let html="<table style='font-size:12px'><tbody>";
  valid.forEach(([k,v])=>{
    const f=k.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase());
    html+=`<tr><th>${f}</th><td>${v}</td></tr>`;
  });
  html+="</tbody></table>";
  return html;
}

const url="https://si.icnf.pt/wfs/pontos_agua?service=WFS&version=2.0.0&request=GetFeature&typeNames=pontos_agua&outputFormat=application/json&srsName=EPSG:4258";

projection.load().then(()=>{
  fetch(url).then(res=>res.json()).then(geojson=>{
    geojson.features.forEach(feat=>{
      const[lon,lat]=feat.geometry.coordinates;
      const pt=new Point({longitude:lon,latitude:lat,spatialReference:{wkid:4258}});
      const projectedPt=projection.project(pt,view.spatialReference);
      const graphic=new Graphic({
        geometry:projectedPt,
        attributes:feat.properties,
        symbol:waterPointSymbol,
        popupTemplate:{title:feat.properties.nome||"Ponto de água",content:createPopupContent(feat.properties)}
      });
      allPoints.push(graphic);
      pointsLayer.add(graphic);

      const distrito=feat.properties.distrito||"Desconhecido";
      const concelho=feat.properties.concelho||"Desconhecido";
      uniqueDistritos.add(distrito);
      if(!distritoConcelhoMap[distrito])distritoConcelhoMap[distrito]=new Set();
      distritoConcelhoMap[distrito].add(concelho);
    });

    Array.from(uniqueDistritos).sort().forEach(d=>{
      distritoFilter.appendChild(new Option(d,d));
    });

    distritoFilter.addEventListener("change",function(){
      const sel=this.value;
      concelhoFilter.innerHTML='<option value="">Todos os concelhos</option>';
      if(sel&&distritoConcelhoMap[sel]){
        Array.from(distritoConcelhoMap[sel]).sort().forEach(c=>{
          concelhoFilter.appendChild(new Option(c,c));
        });
      }
    });

    loadingMessage.classList.add("hidden");
  });
});

function findNearest(pt){
  if(!allPoints.length)return;
  linesLayer.removeAll();
  const distances=allPoints.map(g=>({feature:g,distance:Math.round(geometryEngine.distance(pt,g.geometry,"meters"))}));
  nearest=distances.filter(o=>o.distance<=10000).sort((a,b)=>a.distance-b.distance).slice(0,4);
  nearest.forEach(item=>{
    const line=new Polyline({paths:[[pt.x,pt.y],[item.feature.geometry.x,item.feature.geometry.y]],spatialReference:view.spatialReference});
    linesLayer.add(new Graphic({geometry:line,symbol:lineSymbol}));
  });
  renderInfo();
}

function renderInfo(){
  let html="<h4>Pontos de água mais próximos (até 10 km):</h4>";
  if(!nearest.length){
    html+="<p>Nenhum ponto encontrado.</p>";
  }else{
    html+="<ul>";
    nearest.forEach(o=>{
      const a=o.feature.attributes;
      const name=a.nome||"Sem nome";
      const type=a.tipologia?` (${a.tipologia})`:"";
      html+=`<li>${name}${type} — ${o.distance} m</li>`;
    });
    html+="</ul>";
  }
  infoContent.innerHTML=html;
}

applyFilter.addEventListener("click",function(){
  const distrito=distritoFilter.value,concelho=concelhoFilter.value;
  pointsLayer.removeAll();
  filteredPointsLayer.removeAll();
  allPoints.forEach(g=>{
    const a=g.attributes;
    const matchD=!distrito||a.distrito===distrito;
    const matchC=!concelho||a.concelho===concelho;
    if(matchD&&matchC){
      const fg=g.clone();
      fg.symbol=filteredPointSymbol;
      filteredPointsLayer.add(fg);
    }
  });
});

resetFilter.addEventListener("click",function(){
  distritoFilter.value="";
  concelhoFilter.value="";
  concelhoFilter.innerHTML='<option value="">Todos os concelhos</option>';
  pointsLayer.removeAll();
  filteredPointsLayer.removeAll();
  allPoints.forEach(g=>pointsLayer.add(g));
});

minimizeInfo.addEventListener("click",()=>{
  if(infoPanel.style.height==="30px"){
    infoPanel.style.height="auto";
    infoPanel.style.opacity="1";
    minimizeInfo.textContent="—";
  }else{
    infoPanel.style.height="30px";
    infoPanel.style.opacity="0.5";
    minimizeInfo.textContent="+";
  }
});

minimizeFilter.addEventListener("click",()=>{
  if(filterPanel.style.maxHeight==="20px"){
    filterPanel.style.maxHeight="500px";
    filterPanel.style.opacity="1";
    minimizeFilter.textContent="Ocultar filtros";
  }else{
    filterPanel.style.maxHeight="20px";
    filterPanel.style.opacity="0.5";
    minimizeFilter.textContent="Mostrar filtros";
  }
});

view.on("pointer-move",e=>{
  const pt=view.toMap({x:e.x,y:e.y});
  if(pt)findNearest(pt);
});
});
</script>
</body>
</html>
