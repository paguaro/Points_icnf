<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<title>Pontos de √°gua ICNF + VIIRS</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
<style>
  html, body, #viewDiv { height:100%; width:100%; margin:0; padding:0; -webkit-text-size-adjust:100%; }
  .esri-ui .esri-widget, .esri-ui button, .esri-ui input, .esri-ui select { font-size:12px; line-height:1.2; }

  /* Barra icone (GPS + FUOCO) in alto a destra */
  .iconbar { position:absolute; top:15px; right:10px; z-index:6; display:flex; gap:6px; align-items:center; }
  .iconbtn { background:transparent; border:none; cursor:pointer; padding:6px; min-width:32px; font-size:20px; line-height:1; border-radius:8px; }
  #btnFire { filter:grayscale(1) brightness(.8); transition:filter .15s ease, transform .08s ease; }
  #btnFire[aria-pressed="true"] { filter:none; }
  .iconbtn:active { transform:scale(.96); }

  /* Pannelli */
  #infoPanel, #filterPanel {
    position:absolute; background:#fff; padding:6px 8px; border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:9px; z-index:5;
    overflow-y:auto; transition: all 0.3s ease;
  }
  #infoPanel { top:100px; right:10px; width:min(260px,42vw); max-height:50%; opacity:0.9; }
  #infoPanel.collapsed { max-height:24px; opacity:0.4; padding: 4px; }
  #filterPanel { bottom:120px; left:10px; width:min(180px,32vw); max-height:50%; opacity:0.9; }
  #filterPanel.collapsed { max-height:24px; opacity:0.4; padding: 4px; }
  #infoPanel.collapsed #infoContent { display:none; }
  #filterPanel.collapsed .filter-content { display:none; }

  .toggle-chip {
    position:absolute; top:4px; left:4px; background:#f2f2f2; border:1px solid #ddd;
    cursor:pointer; border-radius:6px; padding:2px 6px; font-size:14px; line-height:1.1; user-select:none;
    z-index: 10;
  }
  .panel-title { display:block; margin-left:22px; margin-bottom:4px; font-size:9px; font-weight:600; }

  select, button { width:100%; padding:6px 8px; margin:2px 0; box-sizing:border-box; font-size:12px; border-radius:6px; }
  button { background-color:#0079c1; color:#fff; border:none; cursor:pointer; }
  button:hover { background-color:#005a8c; }
  .btn-ghost { background:#fff; color:#000; border:1px solid #ccc; }

  .info-table { width:100%; border-collapse:collapse; font-size:11px; }
  .info-table th, .info-table td { text-align:left; padding:2px 4px; border-bottom:1px dotted #eee; vertical-align:top; word-break:break-word; }
  .info-table th { width:40%; color:#444; font-weight:600; }

  /* Toast & Error */
  #toast, #error {
    position:absolute; left:50%; transform:translateX(-50%);
    color:#fff; padding:8px 12px; border-radius:6px; z-index:10; display:none; font-size:13px; box-shadow:0 3px 10px rgba(0,0,0,.2);
  }
  #toast { top:10px; background:#323232; }
  #error { top:50px; background:#d32f2f; }

  /* Loader iniziale */
  #loadingMessage { position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:7; }
  #loadingBox { background:#fff; padding:12px 14px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.2); font-size:14px; }
  .hidden { display:none !important; }

  /* Legenda personalizzata */
  .custom-legend {
    background: white; padding: 8px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    max-height: 250px; overflow-y: auto; font-size: 11px;
  }
  .legend-item { display:flex; align-items:center; margin-bottom:6px; padding:2px; }
  .legend-color { width:14px; height:14px; margin-right:6px; border-radius:50%; }
  .line-color { width:14px; height:3px; margin-right:6px; background-color: rgba(255,0,0,0.6); }
  .legend-label { flex:1; font-size:11px; }
  .legend-checkbox { margin-left:6px; transform:scale(0.8); }

  /* Scala dinamica */
  #scaleBar {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.8); padding: 2px 5px; border-radius: 2px;
    font-size: 8px; z-index: 5; box-shadow:0 1px 3px rgba(0,0,0,0.3);
    color: #ff0000; font-weight: bold;
  }

  /* Widget Selezione (semplice) */
  .select-widget {
    background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15);
    max-width:min(300px, 70vw); font-size:11px;
  }
  .select-widget h4 { margin:0 0 8px 0; font-size:13px; }
  .sel-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .sel-row button { flex:1; min-width:120px; }
  .sel-counter { font-size:11px; margin:6px 0; color:#333; }
</style>
</head>
<body>
  <div id="viewDiv"></div>

  <!-- Barra icone: GPS + FUOCO -->
  <div class="iconbar">
    <button id="btnGPS" class="iconbtn" title="Localizar-me">üìç</button>
    <button id="btnFire" class="iconbtn" title="Inc√™ndios (VIIRS)" aria-pressed="false">üî•</button>
  </div>

  <!-- Pannello info "ponti vicini" -->
  <div id="infoPanel">
    <button id="toggleInfo" class="toggle-chip" title="Minimizar / Expandir">üìã</button>
    <div id="infoContent"></div>
  </div>

  <!-- Pannello filtro (ricerca pontos d'√°gua) -->
  <div id="filterPanel">
    <button id="toggleFilter" class="toggle-chip" title="Minimizar / Expandir">‚öôÔ∏è</button>
    <div class="filter-content">
      <strong class="panel-title">Filtrar</strong>
      <select id="distritoFilter" aria-label="Filtrar por distrito"><option value="">Todos os distritos</option></select>
      <select id="concelhoFilter" aria-label="Filtrar por concelho"><option value="">Todos os concelhos</option></select>
      <div style="display:flex; gap:4px; margin-top:4px;">
        <button id="applyFilter" style="flex:1;">Aplicar</button>
        <button id="resetFilter" class="btn-ghost" style="flex:1;">Repor</button>
      </div>
    </div>
  </div>

  <!-- Scala dinamica -->
  <div id="scaleBar"></div>

  <!-- Toast + Error + Loader -->
  <div id="toast"></div>
  <div id="error"></div>
  <div id="loadingMessage"><div id="loadingBox">A carregar dados‚Ä¶</div></div>

  <script src="https://js.arcgis.com/4.33/"></script>
  <script>
  require([
    "esri/Map","esri/views/MapView",
    "esri/layers/GraphicsLayer","esri/Graphic",
    "esri/geometry/Point","esri/geometry/Polyline","esri/geometry/Extent",
    "esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol",
    "esri/widgets/Search","esri/widgets/BasemapGallery","esri/widgets/Expand",
    "esri/widgets/Zoom","esri/widgets/Home",
    "esri/request","esri/core/reactiveUtils",
    /* Selezione (VM senza UI) */
    "esri/widgets/Sketch/SketchViewModel","esri/geometry/geometryEngine","esri/geometry/support/webMercatorUtils"
  ], function(Map,MapView,GraphicsLayer,Graphic,Point,Polyline,Extent,
              SimpleMarkerSymbol,SimpleLineSymbol,
              Search,BasemapGallery,Expand,
              Zoom,Home,
              esriRequest,reactiveUtils,
              SketchViewModel,geometryEngine,webMercatorUtils){

    /* ====== MAPPA & UI BASE ====== */
    const map = new Map({ basemap: "streets-navigation-vector" });
    const view = new MapView({
      container: "viewDiv", map, center: [-8,39.5], zoom: 7, popupEnabled: true,
      ui: { components: ["attribution"] }
    });

    let initialExtent = null;
    view.when(() => { initialExtent = view.extent.clone(); });

    /* ====== LAYERS ====== */
    const waterLayer = new GraphicsLayer({ title:"Pontos de √Ågua", listMode:"show" });
    const filteredPointsLayer = new GraphicsLayer({ title:"Pontos Filtrados", listMode:"show" });
    const linesLayer = new GraphicsLayer({ title:"Linhas de Conex√£o", listMode:"show" });
    const locLayer = new GraphicsLayer({ title:"Minha Localiza√ß√£o", listMode:"show" });
    const viirsLayer = new GraphicsLayer({ title:"Inc√™ndios VIIRS", listMode:"show" });
    /* Selezione: disegno + highlight */
    const selectionDrawLayer = new GraphicsLayer({ title:"Desenho Selezione", listMode:"hide" });
    const selectionLayer    = new GraphicsLayer({ title:"Sele√ß√£o", listMode:"show" });

    map.addMany([waterLayer, filteredPointsLayer, linesLayer, locLayer, viirsLayer, selectionDrawLayer, selectionLayer]);

    /* ====== WIDGETS A SINISTRA ====== */
    const zoomWidget = new Zoom({ view });          view.ui.add(zoomWidget, { position:"top-left", index:0 });
    const homeWidget = new Home({ view });          view.ui.add(homeWidget, { position:"top-left", index:1 });

    // Legenda
    const legendContainer = document.createElement("div");
    legendContainer.className = "custom-legend";
    legendContainer.innerHTML = '<h4 style="margin:0 0 8px 0; font-size:12px;">Legenda</h4>';
    const legendExpand = new Expand({ view, content: legendContainer, expanded:false, expandIconClass:"esri-icon-layer-list", expandTooltip:"Legenda" });
    view.ui.add(legendExpand, { position:"top-left", index:2 });

    // Search
    const searchWidget = new Search({ view });
    const searchExpand = new Expand({ view, content: searchWidget, expanded:false, expandIcon:"search", expandTooltip:"Pesquisar localiza√ß√£o" });
    view.ui.add(searchExpand, { position:"top-left", index:3 });

    // Basemap
    const basemapGallery = new BasemapGallery({ view });
    const bgExpand = new Expand({ view, content: basemapGallery, expandIconClass:"esri-icon-basemap", expandTooltip:"Mudar mapa base" });
    view.ui.add(bgExpand, "bottom-right");
    basemapGallery.watch("activeBasemap", () => { bgExpand.expanded = false; });

    /* ====== UI elementi ====== */
    const btnGPS = document.getElementById("btnGPS");
    const btnFire = document.getElementById("btnFire");
    const infoPanel = document.getElementById("infoPanel");
    const infoContent = document.getElementById("infoContent");
    const toggleInfo = document.getElementById("toggleInfo");
    const filterPanel = document.getElementById("filterPanel");
    const toggleFilter = document.getElementById("toggleFilter");
    const distritoFilter = document.getElementById("distritoFilter");
    const concelhoFilter = document.getElementById("concelhoFilter");
    const applyFilter = document.getElementById("applyFilter");
    const resetFilter = document.getElementById("resetFilter");
    const toast = document.getElementById("toast");
    const errorBox = document.getElementById("error");
    const loadingMsg = document.getElementById("loadingMessage");
    const scaleBar = document.getElementById("scaleBar");

    /* ====== Stato ====== */
    const allPoints = [];
    const distritoConcelho = {};
    const uniqueDistritos = new Set();
    let spatialGrid = {};
    let nearest = [];
    let isVIIRSLoading = false;

    /* ====== Simboli ====== */
    const symWater    = new SimpleMarkerSymbol({ color:[0,112,255,0.9], outline:{ color:[80,220,255], width:1 }, size:5 });
    const symFiltered = new SimpleMarkerSymbol({ color:[0,112,255,0.85], outline:{ color:[255,230,120], width:1 }, size:6 });
    const symLocation = new SimpleMarkerSymbol({ color:[0,200,0,0.9], outline:{ color:[255,255,255], width:2 }, size:10 });
    const symLine     = new SimpleLineSymbol({ color:[255,0,0,0.7], width:1.5, style:"short-dash" });
    const symFire     = new SimpleMarkerSymbol({ color:[255,64,0,0.9], outline:null, size:6 });
    /* Selezione */
    const symSelectedPoint = new SimpleMarkerSymbol({ style:"circle", color:[0,0,0,0], outline:{ color:[255,215,0,0.95], width:2 }, size:12 });
    const symSelectedLine  = new SimpleLineSymbol({ color:[255,215,0,0.95], width:3 });

    /* ====== Util ====== */
    function showToast(msg, ms=2000){ toast.textContent = msg; toast.style.display = "block"; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display="none", ms); }
    function showError(msg, ms=5000){ errorBox.textContent = msg; errorBox.style.display = "block"; clearTimeout(showError._t); showError._t = setTimeout(()=> errorBox.style.display="none", ms); }

    function togglePanel(panel, btn){
      const isFilterPanel = panel.id === "filterPanel";
      const collapsed = panel.classList.contains("collapsed");
      if(collapsed){ panel.classList.remove("collapsed"); btn.textContent = isFilterPanel ? "‚öôÔ∏è" : "üìã"; }
      else { panel.classList.add("collapsed"); btn.textContent = "‚ñ∂"; }
    }
    toggleInfo.addEventListener("click", ()=> togglePanel(infoPanel, toggleInfo));
    toggleFilter.addEventListener("click", ()=> togglePanel(filterPanel, toggleFilter));

    // Legenda
    function updateLegend() {
      while (legendContainer.children.length > 1) legendContainer.removeChild(legendContainer.lastChild);
      map.layers.forEach(layer => {
        if (layer.title && layer.listMode === "show") {
          const item = document.createElement("div"); item.className = "legend-item";
          const colorBox = document.createElement("div");
          if (layer.title === "Pontos de √Ågua")        { colorBox.className = "legend-color"; colorBox.style.backgroundColor = "rgba(0,112,255,0.85)"; }
          else if (layer.title === "Pontos Filtrados") { colorBox.className = "legend-color"; colorBox.style.backgroundColor = "rgba(2,64,64,0.9)"; }
          else if (layer.title === "Linhas de Conex√£o"){ colorBox.className = "line-color"; }
          else if (layer.title === "Minha Localiza√ß√£o"){ colorBox.className = "legend-color"; colorBox.style.backgroundColor = "rgba(0,200,0,0.9)"; }
          else if (layer.title === "Inc√™ndios VIIRS")  { colorBox.className = "legend-color"; colorBox.style.backgroundColor = "rgba(255,64,0,0.9)"; }
          else if (layer.title === "Sele√ß√£o")          { colorBox.className = "legend-color"; colorBox.style.backgroundColor = "rgba(255,215,0,0.95)"; }

          const label = document.createElement("span"); label.className = "legend-label"; label.textContent = layer.title;
          const checkbox = document.createElement("input"); checkbox.type = "checkbox"; checkbox.className = "legend-checkbox"; checkbox.checked = layer.visible;
          checkbox.addEventListener("change", () => { layer.visible = checkbox.checked; });
          item.appendChild(colorBox); item.appendChild(label); item.appendChild(checkbox);
          legendContainer.appendChild(item);
        }
      });
    }
    map.layers.on("change", updateLegend);

    // Barra scala
    function updateScaleBar() {
      const scale = view.scale;
      let distance, unit;
      if (scale > 1000000) { distance = Math.round(scale / 100000) * 100; unit = "km"; distance = distance / 100; }
      else if (scale > 1000) { distance = Math.round(scale / 100) * 100; unit = "m"; }
      else { distance = Math.round(scale); unit = "m"; }
      scaleBar.textContent = unit === "m" ? `${distance.toLocaleString('pt-PT')} m` : `${distance} ${unit}`;
    }
    view.watch("scale", updateScaleBar);
    view.watch("center", updateScaleBar);

    /* ====== Caricamento pontos de √°gua (ICNF WFS) ====== */
    const wfsUrl = "https://si.icnf.pt/wfs/pontos_agua?service=WFS&version=2.0.0&request=GetFeature&typeNames=pontos_agua&outputFormat=application/json&srsName=EPSG:4326";
    esriRequest(wfsUrl, { responseType:"json" })
      .then(r=>{
        const gj=r.data; if(!gj?.features) throw new Error("GeoJSON vazio.");
        ingestWater(gj.features); updateLegend(); updateScaleBar();
      })
      .catch(e=> { console.warn(e); showError("Falha ao carregar pontos de √°gua."); })
      .finally(()=> loadingMsg.classList.add("hidden"));

    function createWaterPopupTemplate(attrs) {
      return {
        title: attrs.nome || attrs.tipologia || "Ponto de √°gua",
        content: function(event) {
          const graphic = event.graphic, attrs = graphic.attributes || {}, geom = graphic.geometry;
          const lat = Number(geom.latitude).toFixed(6), lon = Number(geom.longitude).toFixed(6);
          return buildTable(attrs) + "<div style='margin-top:8px;'><strong>Coordenadas:</strong> " + lat + ", " + lon + "</div>";
        },
        actions: [
          { title:"Waze", id:"open-waze", image:"https://paguaro.github.io/Points_icnf/waze-icon.png" },
          { title:"Google Maps", id:"open-google-maps", image:"https://paguaro.github.io/Points_icnf/google-maps-icon.png" },
          { title:"Copiar Coordenadas", id:"copy-coords", image:"https://paguaro.github.io/Points_icnf/coordinates-icon.png" },
          { title:"Copiar GeoJSON", id:"copy-geojson", image:"https://paguaro.github.io/Points_icnf/geojson-icon.png" }
        ]
      };
    }

    function createVIIRSPopupTemplate(attrs) {
      const frp = attrs.Frp || attrs.frp || "N/A";
      const hoursOld = attrs["Hours Old"] || attrs.hours_old || "N/A";
      return {
        title: `VIIRS FRP: ${frp} MW | Hours Old: ${hoursOld}`,
        content: function(event) {
          const graphic = event.graphic, attrs = graphic.attributes || {}, geom = graphic.geometry;
          const lat = Number(geom.latitude).toFixed(6), lon = Number(geom.longitude).toFixed(6);
          const viirsFields = ["Acq Date","Acq Time","Bright Ti4","Bright Ti5","Confidence","Daynight","Esritimeutc","Frp","Hours Old","Latitude","Longitude","OBJECTID","Satellite","Scan","Track","Version"];
          let content = "<table class='info-table'><tbody>";
          for (const field of viirsFields) {
            const value = attrs[field] || attrs[field.toLowerCase()] || attrs[field.replace(/\s+/g,'_').toLowerCase()] || attrs[field.replace(/\s+/g,'')] || "N/A";
            if (value !== "N/A") {
              const displayValue = (field === "Frp" || field === "frp") ? `${value} MW` : value;
              content += `<tr><th>${field}</th><td>${displayValue}</td></tr>`;
            }
          }
          content += "</tbody></table>";
          content += "<div style='margin-top:8px;'><strong>Coordenadas:</strong> " + lat + ", " + lon + "</div>";
          return content;
        },
        actions: [
          { title:"Waze", id:"open-waze", image:"https://paguaro.github.io/Points_icnf/waze-icon.png" },
          { title:"Google", id:"open-google-maps", image:"https://paguaro.github.io/Points_icnf/google-maps-icon.png" },
          { title:"Copiar Coordenadas", id:"copy-coords", image:"https://paguaro.github.io/Points_icnf/coordinates-icon.png" },
          { title:"Copiar GeoJSON", id:"copy-geojson", image:"https://paguaro.github.io/Points_icnf/geojson-icon.png" }
        ]
      };
    }

    function ingestWater(features){
      for(const f of features){
        const c = f.geometry && f.geometry.coordinates; if(!c) continue;
        const pt = new Point({ longitude:+c[0], latitude:+c[1] });
        const attrs = f.properties || {};
        const g = new Graphic({ geometry:pt, attributes:attrs, symbol:symWater, popupTemplate: createWaterPopupTemplate(attrs) });
        allPoints.push(g); waterLayer.add(g);

        const d = attrs.distrito || "Desconhecido";
        const ccl = attrs.concelho || "Desconhecido";
        uniqueDistritos.add(d);
        if(!distritoConcelho[d]) distritoConcelho[d] = new Set();
        distritoConcelho[d].add(ccl);
      }
      for(const d of Array.from(uniqueDistritos).sort()) distritoFilter.appendChild(new Option(d,d));
      if(view.center) findNearest(view.center);
    }

    function buildTable(attrs){
      const rows = Object.entries(attrs||{}).filter(([k,v])=> v!=null && v!=="").sort((a,b)=> a[0].localeCompare(b[0]));
      let html="<table class='info-table'><tbody>";
      for(const [k,v] of rows){
        const label=k.replace(/_/g," ").replace(/\b\w/g, l=>l.toUpperCase());
        html += "<tr><th>"+label+"</th><td>"+v+"</td></tr>";
      }
      html += "</tbody></table>";
      return html;
    }

    // Popup actions
    reactiveUtils.on(() => view.popup, "trigger-action", (event) => {
      const graphic = view.popup.selectedFeature; if (!graphic) return;
      const geom = graphic.geometry; const lat = geom.latitude?.toFixed(6); const lon = geom.longitude?.toFixed(6);
      const attrs = graphic.attributes;
      switch(event.action.id) {
        case "open-waze":        openNavigation("waze", lat, lon); break;
        case "open-google-maps": openNavigation("google", lat, lon); break;
        case "copy-coords":      copyToClipboard(`${lat}, ${lon}`); showToast("Coordenadas copiadas!"); break;
        case "copy-geojson":     copyGeoJSON(attrs, lat, lon); break;
      }
    });

    function openNavigation(app, lat, lon) {
      const url = app === "waze"
        ? `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`
        : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
      window.open(url, '_blank');
    }
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).catch(err => {
        console.error("Erro ao copiar:", err);
        const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand("copy"); document.body.removeChild(ta);
      });
    }
    function copyGeoJSON(attributes, lat, lon) {
      const geoJSON = { type:"Feature", geometry:{ type:"Point", coordinates:[parseFloat(lon), parseFloat(lat)] }, properties:{...attributes} };
      copyToClipboard(JSON.stringify(geoJSON, null, 2)); showToast("GeoJSON copiado para a √°rea de transfer√™ncia!");
    }

    /* ====== Filtro distritos/concelhos ====== */
    distritoFilter.addEventListener("change", function(){
      concelhoFilter.innerHTML = '<option value="">Todos os concelhos</option>';
      const s = distritoConcelho[this.value];
      if(s) Array.from(s).sort().forEach(c=> concelhoFilter.appendChild(new Option(c,c)));
    });
    applyFilter.addEventListener("click", ()=>{
      filteredPointsLayer.removeAll();
      const d = distritoFilter.value, c = concelhoFilter.value;
      for(const g of allPoints){
        const a=g.attributes||{};
        if((!d || a.distrito===d) && (!c || a.concelho===c)){
          const gg = g.clone(); gg.symbol = symFiltered; filteredPointsLayer.add(gg);
        }
      }
      const tgt = filteredPointsLayer.graphics.items.length ? filteredPointsLayer.graphics.items : waterLayer.graphics.items;
      fitToGraphics(tgt, 60);
      if(view.center) findNearest(view.center);
    });
    resetFilter.addEventListener("click", ()=>{
      distritoFilter.value=""; concelhoFilter.value="";
      concelhoFilter.innerHTML = '<option value="">Todos os concelhos</option>';
      filteredPointsLayer.removeAll();
      fitToGraphics(waterLayer.graphics.items, 60);
      if(view.center) findNearest(view.center);
    });

    function fitToGraphics(graphics, padding=40){
      if(!graphics || !graphics.length) return;
      let xmin=Infinity, ymin=Infinity, xmax=-Infinity, ymax=-Infinity;
      for(const g of graphics){
        const geom=g.geometry; if(!geom) continue;
        const x = geom.longitude ?? geom.x, y = geom.latitude ?? geom.y;
        if(typeof x!=='number' || typeof y!=='number') continue;
        if(x<xmin) xmin=x; if(y<ymin) ymin=y; if(x>xmax) xmax=x; if(y>ymax) ymax=y;
      }
      if(!isFinite(xmin)||!isFinite(ymin)||!isFinite(xmax)||!isFinite(ymax)) return;
      const ext = new Extent({ xmin, ymin, xmax, ymax, spatialReference:{ wkid:4326 } });
      view.goTo({ target:ext, padding }).catch(()=>{});
    }

    /* ====== Nearest (pontos de √°gua) ====== */
    function buildSpatialGrid(points, gridSize=0.5){
      spatialGrid={};
      for(const p of points){
        const lon=p.geometry.longitude, lat=p.geometry.latitude;
        const gx=Math.floor(lon/gridSize), gy=Math.floor(lat/gridSize);
        const key=`${gx},${gy}`; if(!spatialGrid[key]) spatialGrid[key]=[];
        spatialGrid[key].push(p);
      }
    }
    function haversineMeters(a,b){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.latitude-a.latitude), dLon=toRad(b.longitude-a.longitude);
      const lat1=toRad(a.latitude), lat2=toRad(b.latitude);
      const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return Math.round(2*R*Math.asin(Math.sqrt(s)));
    }
    function findNearest(pt){
      if(!allPoints.length || !pt) return;
      linesLayer.removeAll();
      if(Object.keys(spatialGrid).length===0) buildSpatialGrid(allPoints);
      const active = filteredPointsLayer.graphics.items.length ? filteredPointsLayer.graphics.items : allPoints;
      const gridSize=0.5, gx=Math.floor(pt.longitude/gridSize), gy=Math.floor(pt.latitude/gridSize);
      let candidates=[];
      for(let x=gx-2; x<=gx+2; x++){
        for(let y=gy-2; y<=gy+2; y++){
          const key=`${x},${y}`; const cell=spatialGrid[key]; if(!cell) continue;
          for(const g of cell) if(active.includes(g)){
            candidates.push({ feature:g, distance:haversineMeters(pt, g.geometry) });
          }
        }
      }
      if(candidates.length<4) candidates = active.map(g=>({ feature:g, distance:haversineMeters(pt, g.geometry) }));
      nearest = candidates.filter(o=> o.distance<=10000).sort((a,b)=>a.distance-b.distance).slice(0,4);
      for(const item of nearest){
        const line=new Polyline({ paths:[[pt.longitude,pt.latitude],[item.feature.geometry.longitude,item.feature.geometry.latitude]], spatialReference:{ wkid:4326 } });
        linesLayer.add(new Graphic({ geometry:line, symbol:symLine }));
      }
      renderInfo();
    }
    function renderInfo(){
      let html="<h4 style='margin:4px 0 6px'>Pontos de √°gua mais pr√≥ximos <small>(at√© 10 km)</small>:</h4>";
      if(!nearest.length){ html+="<p style='margin:0'>Nenhum punto encontrado.</p>"; }
      else {
        html+="<ul style='margin:0; padding-left:16px; font-size:12px;'>";
        for(const o of nearest){
          const a=o.feature.attributes||{}; const name=a.nomenome||a.nome||"Sem nome";
          const type=a.tipologia?(" ("+a.tipologia+")"):"";
          html+="<li>"+name+type+" ‚Äî "+o.distance.toLocaleString('pt-PT')+" m</li>";
        }
        html+="</ul>";
      }
      infoContent.innerHTML=html;
    }
    // Interazioni (stile Document7: nessun debounce = tracking pi√π reattivo)
view.on("pointer-move", (e) => {
  const pt = view.toMap({ x: e.x, y: e.y });
  if (pt) findNearest(pt);
});
view.on("pointer-down", (e) => {
  const pt = view.toMap({ x: e.x, y: e.y });
  if (pt) findNearest(pt);
});
view.on("drag", () => {
  if (view.center) findNearest(view.center.clone());
});
view.when(() => {
  if (view.center) findNearest(view.center);
});


    /* ====== GPS ====== */
    btnGPS.addEventListener("click", ()=>{
      if(!navigator.geolocation) return showError("Geolocaliza√ß√£o n√£o suportada.");
      navigator.geolocation.getCurrentPosition(
        p=>{
          const pt = new Point({ longitude:p.coords.longitude, latitude:p.coords.latitude });
          view.goTo({ target:pt, zoom:14 }).catch(()=>{});
          locLayer.removeAll();
          locLayer.add(new Graphic({ geometry:pt, symbol:symLocation }));
          showToast("Localiza√ß√£o definida"); findNearest(pt);
        },
        ()=> showError("N√£o foi poss√≠vel obter a localiza√ß√£o."),
        { enableHighAccuracy:true, maximumAge:30000, timeout:10000 }
      );
    });

    /* ====== VIIRS ====== */
    const VIIRS_QUERY_BASE =
      "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query";
    function viirsGeoJsonUrl(){
      const europeEnv = { xmin:-31, ymin:35, xmax:10, ymax:44, spatialReference:{ wkid:4326 } };
      const endMs = Date.now(), startMs = endMs - 96*3600*1000;
      const params = new URLSearchParams({
        where:"1=1", outFields:"*", outSR:"4326", f:"geojson", returnGeometry:"true",
        geometry: JSON.stringify(europeEnv), geometryType:"esriGeometryEnvelope", inSR:"4326", spatialRel:"esriSpatialRelIntersects",
        time: `${startMs},${endMs}`
      });
      return `${VIIRS_QUERY_BASE}?${params.toString()}`;
    }
    let viirsFeaturesCache = []; let viirsOn = false;
    async function loadVIIRSAll(){
      if (isVIIRSLoading) return; isVIIRSLoading = true; btnFire.classList.add("fire-loading");
      try{
        const res = await fetch(viirsGeoJsonUrl(), { method:"GET", mode:"cors", credentials:"omit", cache:"no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const gj = await res.json(); if(!gj || !Array.isArray(gj.features)) throw new Error("GeoJSON n√£o v√°lido");
        drawVIIRS(gj.features); showToast("Inc√™ndios VIIRS: ON"); updateLegend();
      } catch(err){
        console.error("VIIRS fetch error:", err);
        showError("Falha ao carregar dados de inc√™ndios (VIIRS).");
        clearVIIRS(); btnFire.setAttribute("aria-pressed","false"); viirsOn = false;
      } finally {
        isVIIRSLoading = false; btnFire.classList.remove("fire-loading");
      }
    }
    function drawVIIRS(features){ viirsFeaturesCache = features || []; redrawVIIRS(); }
    function redrawVIIRS(){
      viirsLayer.removeAll();
      const scale = view.scale || 1000000;
      for (const f of viirsFeaturesCache){
        const c = f.geometry && f.geometry.coordinates; if (!c) continue;
        const attrs = f.properties || {}; const lon = +c[0], lat = +c[1];
        const frp = Number(attrs.frp ?? attrs.FRP ?? attrs.frp_mw ?? attrs.FRP_MW);
        const h = hoursSinceFromAttrs(attrs); const a = viirsAlpha(h);
        const sizes = viirsClass(frp); const delta = sizeDeltaForScale(scale);
        if (sizes.halo){
          viirsLayer.add(new Graphic({
            geometry: { type:"point", longitude: lon, latitude: lat },
            attributes: attrs,
            symbol: new SimpleMarkerSymbol({ style:"circle", color:[255,235,59, Math.min(1, a*0.9)], size: sizes.halo + delta, outline:{ color:[255,255,255,0], width:0 } }),
            popupTemplate: createVIIRSPopupTemplate(attrs)
          }));
        }
        viirsLayer.add(new Graphic({
          geometry: { type:"point", longitude: lon, latitude: lat },
          attributes: attrs,
          symbol: new SimpleMarkerSymbol({ style:"circle", color:[229,57,53, a], size: sizes.core + delta, outline:{ color:[60,0,0, a], width:0 } }),
          popupTemplate: createVIIRSPopupTemplate(attrs)
        }));
      }
    }
    function clearVIIRS(){ viirsLayer.removeAll(); viirsFeaturesCache = []; }
    btnFire.addEventListener("click", ()=>{
      const on = btnFire.getAttribute("aria-pressed")==="true";
      if(on){ btnFire.setAttribute("aria-pressed","false"); viirsOn=false; clearVIIRS(); showToast("Inc√™ndios VIIRS: OFF"); }
      else { btnFire.setAttribute("aria-pressed","true"); viirsOn=true; loadVIIRSAll(); }
    });
    view.watch("scale", ()=>{ if (viirsOn && viirsFeaturesCache.length) redrawVIIRS(); });
    function viirsAlpha(hours){ if (hours==null||!isFinite(hours)) return 1; if (hours<=12) return 1; if (hours>=36) return 0.25; const t=(hours-12)/24; return 1 - 0.75*t; }
    function hoursSinceFromAttrs(attrs){
      if (attrs.esritimeutc) { const ms=Number(attrs.esritimeutc); if (Number.isFinite(ms)) return (Date.now() - ms)/36e5; }
      if (attrs.ACQ_DATE && attrs.ACQ_TIME){ try{ const d=new Date(attrs.ACQ_DATE); const t=String(attrs.ACQ_TIME).padStart(4,'0'); d.setUTCHours(Number(t.slice(0,2)), Number(t.slice(2,4)), 0, 0); return (Date.now()-d.getTime())/36e5; }catch(_){ } }
      return null;
    }
    function viirsClass(frp){ if (frp>750) return { core:12, halo:18 }; if (frp>300) return { core:10, halo:14 }; if (frp>100) return { core:8, halo:0 }; if (frp>10) return { core:6, halo:0 }; return { core:4, halo:0 }; }
    function sizeDeltaForScale(scale){ if (scale>2000000) return 0; if (scale>1000000) return 1; if (scale>500000) return 2; if (scale>250000) return 2; if (scale>35000) return 3; return 3; }

    // Inizializza legenda & scala
    updateLegend(); updateScaleBar();

    /* =======================================================================================
       WIDGET ‚ÄúSELEZIONE‚Äù ‚Äî rettangolo ‚Üí raccoglie feature dei layer visibili ‚Üí GeoJSON
       (semplice: contains-only)
       ======================================================================================= */
    const selContainer = document.createElement("div");
    selContainer.className = "select-widget";
    selContainer.innerHTML = `
      <h4>Selezione</h4>
      <div class="sel-row">
        <button id="btnSelectRect">Rettangolo</button>
        <button id="btnClearSel" class="btn-ghost">Pulisci</button>
      </div>
      <div class="sel-row" style="margin-top:4px;">
        <button id="btnCopySel" class="btn-ghost">Copia GeoJSON</button>
        <button id="btnDownloadSel">Scarica .geojson</button>
      </div>
      <div class="sel-counter">Selezionati: <strong id="selCount">0</strong></div>
    `;
    const selectExpand = new Expand({
      view, content: selContainer, expanded:false,
      expandIconClass:"esri-icon-cursor",   /* icona DIVERSA dalla Legenda */
      expandTooltip:"Selezione"
    });
    view.ui.add(selectExpand, { position: "top-left", index: 4 });

    // SketchViewModel (niente UI nativa: disegno programm.)
    const sketchVM = new SketchViewModel({
      view,
      layer: selectionDrawLayer,
      polygonSymbol: {
        type: "simple-fill",
        color: [0, 0, 0, 0.06],
        outline: { color: [0, 0, 0, 0.5], width: 1 }
      }
    });

    const selCountEl = selContainer.querySelector("#selCount");
    const btnSelectRect = selContainer.querySelector("#btnSelectRect");
    const btnClearSel  = selContainer.querySelector("#btnClearSel");
    const btnCopySel   = selContainer.querySelector("#btnCopySel");
    const btnDownloadSel = selContainer.querySelector("#btnDownloadSel");

    let selectedItems = []; // { geometry, attributes, layerTitle }

    // Helper SR
    const toWGS84 = (geom) => {
      if (!geom) return geom;
      const sr = geom.spatialReference;
      if (sr && (sr.wkid === 4326 || sr.isWGS84)) return geom;
      return webMercatorUtils.webMercatorToGeographic(geom);
    };

    // Start draw
    btnSelectRect.addEventListener("click", ()=>{
      selectionDrawLayer.removeAll(); selectionLayer.removeAll(); selectedItems = []; updateSelCounter();
      sketchVM.create("rectangle");
    });
    btnClearSel.addEventListener("click", ()=>{
      selectionDrawLayer.removeAll(); selectionLayer.removeAll(); selectedItems = []; updateSelCounter();
    });

    // Esecuzione quando il rettangolo √® completo
    sketchVM.on("create", (evt)=>{
      if (evt.state === "complete" && evt.graphic?.geometry) {
        const rectWgs = toWGS84(evt.graphic.geometry);
        // (opzionale) lasciare il rettangolo: rimuovo per avere solo gli highlight
        // selectionDrawLayer.removeAll();
        runSelection(rectWgs);
      }
    });

    function updateSelCounter(){ selCountEl.textContent = selectedItems.length.toString(); }

    function visibleGraphicsLayers(){
      const ignore = new Set([linesLayer, locLayer, selectionDrawLayer, selectionLayer]);
      const arr = [];
      map.layers.forEach(layer=>{
        if (layer.visible && layer instanceof GraphicsLayer && !ignore.has(layer)) arr.push(layer);
      });
      return arr;
    }

    function quickPointInExtent(pt, ext){
      return (pt.longitude >= ext.xmin && pt.longitude <= ext.xmax && pt.latitude >= ext.ymin && pt.latitude <= ext.ymax);
    }

    function runSelection(rectWgs){
      selectionLayer.removeAll(); selectedItems = [];
      const layers = visibleGraphicsLayers();
      const ext = rectWgs.extent;

      for (const layer of layers){
        layer.graphics.items.forEach(g=>{
          if (!g.geometry) return;
          const gWgs = (g.geometry.spatialReference?.wkid === 4326) ? g.geometry : toWGS84(g.geometry);
          const type = gWgs.type;

          // Prefiltro rapido su extent
          if (type === "point") {
            if (!quickPointInExtent(gWgs, ext)) return;
          } else {
            const gExt = gWgs.extent;
            if (gExt && !geometryEngine.intersects(ext, gExt)) return;
          }

          // Contains only (semplicit√† richiesta)
          let hit = geometryEngine.contains(rectWgs, gWgs);

          if (hit){
            selectedItems.push({ geometry: gWgs.clone(), attributes: {...g.attributes}, layerTitle: layer.title || "layer" });
            if (type === "point")   selectionLayer.add(new Graphic({ geometry:gWgs, symbol:symSelectedPoint }));
            else                    selectionLayer.add(new Graphic({ geometry:gWgs, symbol:symSelectedLine }));
          }
        });
      }

      updateSelCounter();
      showToast(`Selezionate ${selectedItems.length} feature`);
      if (selectedItems.length){
        // zoom sui risultati
        const geoms = selectedItems.map(it => it.geometry);
        const unionExt = geoms.reduce((acc, g) => acc ? acc.union(g.extent) : g.extent, null);
        if (unionExt) view.goTo({ target: unionExt.expand(1.2) }).catch(()=>{});
      }
    }

    // FeatureCollection GeoJSON
    function selectionToGeoJSON(){
      const fc = { type:"FeatureCollection", features: [] };
      for (const it of selectedItems){
        const g = it.geometry;
        let geom = null;
        if (g.type === "point"){
          geom = { type:"Point", coordinates:[g.longitude ?? g.x, g.latitude ?? g.y] };
        } else if (g.type === "polyline"){
          if (g.paths?.length > 1) geom = { type:"MultiLineString", coordinates: g.paths.map(path => path.map(([x,y]) => [x,y])) };
          else geom = { type:"LineString", coordinates: (g.paths?.[0]||[]).map(([x,y]) => [x,y]) };
        } else if (g.type === "polygon"){
          if (g.rings) geom = { type:"Polygon", coordinates: g.rings.map(r => r.map(([x,y]) => [x,y])) };
        }
        if (!geom) continue;
        const props = { ...it.attributes, _layer: it.layerTitle };
        fc.features.push({ type:"Feature", geometry: geom, properties: props });
      }
      return fc;
    }

    // Copia / Download
    btnCopySel.addEventListener("click", ()=>{
      if (!selectedItems.length) { showToast("Nessuna feature selezionata"); return; }
      const fc = selectionToGeoJSON();
      copyToClipboard(JSON.stringify(fc, null, 2));
      showToast("GeoJSON copiato negli appunti");
    });
    btnDownloadSel.addEventListener("click", ()=>{
      if (!selectedItems.length) { showToast("Nessuna feature selezionata"); return; }
      const fc = selectionToGeoJSON();
      const blob = new Blob([JSON.stringify(fc, null, 2)], { type: "application/geo+json" });
      const url = URL.createObjectURL(blob);
      const ts = new Date();
      const pad = n => String(n).padStart(2,"0");
      const fname = `selezione_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.geojson`;
      const a = document.createElement("a");
      a.href = url; a.download = fname; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    });
    /* ======================================================================================= */

  });
  </script>
</body>
</html>
