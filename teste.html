<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<title>Pontos de √°gua ICNF + VIIRS</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
<style>
  html, body, #viewDiv { height:100%; width:100%; margin:0; padding:0; -webkit-text-size-adjust:100%; }
  .esri-ui .esri-widget, .esri-ui button, .esri-ui input, .esri-ui select { font-size:12px; line-height:1.2; }

  /* Bottoni custom (stile ArcGIS) */
  .esri-btn-icon.esri-widget.esri-widget--button {
    display:flex; align-items:center; justify-content:center;
    font-size:20px; width:32px; height:32px; border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,.25); background:#fff;
  }
  .esri-btn-icon:active { transform: scale(.96); }

  /* FIAMMA */
  #btnFireHeader {
    position:absolute; top:4px; right:6px; z-index:2;
    background:transparent; border:none; font-size:26px; line-height:1; padding:4px; cursor:pointer;
    filter: grayscale(1) brightness(.8); transition: filter .15s ease, transform .08s ease;
  }
  #btnFireHeader[aria-pressed="true"] { filter:none; }
  #btnFireHeader:active { transform: scale(.96); }

  /* Pannelli */
  #infoPanel, #filterPanel {
    position:absolute; background:#fff; padding:8px 10px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:9px; z-index:5; max-height:50%;
    overflow-y:auto;
  }
  #infoPanel { top:110px; right:10px; width:min(260px,42vw); }
  #filterPanel { top:130px; left:10px; width:min(180px,32vw); }

  .toggle-chip {
    position:absolute; top:4px; left:6px; background:#f2f2f2; border:1px solid #ddd;
    cursor:pointer; border-radius:8px; padding:2px 6px; font-size:14px; line-height:1.1; user-select:none;
  }
  .panel-title { margin:0 32px 6px 32px; font-size:11px; font-weight:700; text-align:center; color:#0b4f71; }

  select, .btn { width:100%; padding:8px 10px; margin:4px 0; box-sizing:border-box; font-size:12px; border-radius:8px; }
  .btn { background-color:#0079c1; color:#fff; border:none; cursor:pointer; }
  .btn:hover { background-color:#005a8c; }
  .btn-ghost { background:#fff; color:#000; border:1px solid #ccc; }

  .info-table { width:100%; border-collapse:collapse; font-size:11px; }
  .info-table th, .info-table td { text-align:left; padding:2px 4px; border-bottom:1px dotted #eee; vertical-align:top; word-break:break-word; }
  .info-table th { width:40%; color:#444; font-weight:600; }

  #toast {
    position:absolute; top:62px; right:10px;
    background:#323232; color:#fff; padding:6px 10px; border-radius:6px;
    z-index:10; display:none; font-size:12px; box-shadow:0 3px 10px rgba(0,0,0,.2);
  }

  #loadingMessage { position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:7; }
  #loadingBox { background:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.2); font-size:14px; }

  .esri-popup__main-container { max-width: 290px; border-radius: 10px; }
  .esri-popup .esri-popup__header, .esri-popup__content, .esri-popup__footer { padding: 6px 8px; }
  .esri-popup .esri-popup__header-title { font-size: 13px; line-height: 1.2; }
  .esri-popup .esri-popup__content { font-size: 12px; }
  .esri-popup .esri-popup__footer { font-size: 12px; }
</style>
</head>
<body>
  <div id="viewDiv"></div>

  <div id="infoPanel" aria-live="polite">
    <button id="toggleInfo" class="toggle-chip" title="Minimizar / Expandir">üìã</button>
    <button id="btnFireHeader" title="Inc√™ndios (VIIRS)" aria-pressed="false">üî•</button>
    <h4 class="panel-title">Pontos de √°gua pr√≥ximos</h4>
    <div id="infoContent"></div>
  </div>

  <div id="filterPanel">
    <button id="toggleFilter" class="toggle-chip" title="Minimizar / Expandir">‚öôÔ∏è</button>
    <strong class="panel-title">Filtrar</strong>
    <select id="distritoFilter" aria-label="Filtrar por distrito"><option value="">Todos os distritos</option></select>
    <select id="concelhoFilter" aria-label="Filtrar por concelho"><option value="">Todos os concelhos</option></select>
    <div style="display:flex; gap:6px; margin-top:4px;">
      <button id="applyFilter" class="btn" style="flex:1;">Aplicar</button>
      <button id="resetFilter" class="btn-ghost" style="flex:1;">Repor</button>
    </div>
  </div>

  <div id="toast"></div>
  <div id="loadingMessage"><div id="loadingBox">A carregar dados‚Ä¶</div></div>

  <script src="https://js.arcgis.com/4.33/"></script>
  <script>
  require([
    "esri/Map","esri/views/MapView",
    "esri/layers/GraphicsLayer","esri/Graphic",
    "esri/geometry/Point","esri/geometry/Polyline","esri/geometry/Extent",
    "esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol",
    "esri/widgets/Search","esri/widgets/BasemapGallery","esri/widgets/Expand",
    "esri/core/reactiveUtils"
  ], function(Map,MapView,GraphicsLayer,Graphic,Point,Polyline,Extent,
              SimpleMarkerSymbol,SimpleLineSymbol,Search,BasemapGallery,Expand,reactiveUtils){

    const map = new Map({ basemap: "streets-navigation-vector" });
    const initialCenter = [-8, 39.5];
    const initialZoom = 7;
    const view = new MapView({ container:"viewDiv", map, center:initialCenter, zoom:initialZoom, popupEnabled:true });

    /* Popup */
    view.when(() => {
      view.popup.dockEnabled = false;
      view.popup.dockOptions = { breakpoint: false };
      view.popup.collapseEnabled = true;
      view.popup.spinnerEnabled = false;
      view.popup.alignment = "top-center";
      view.popup.actions = [];
    });

    /* Basemap gallery (in basso a destra) */
    const basemapGallery = new BasemapGallery({ view });
    const bgExpand = new Expand({ view, content: basemapGallery, expandIconClass:"esri-icon-basemap" });
    view.ui.add(bgExpand, "bottom-right");
    reactiveUtils.watch(() => basemapGallery.activeBasemap, () => { bgExpand.expanded = false; });

    /* LAYERS */
    const waterLayer = new GraphicsLayer(); map.add(waterLayer);
    const filteredPointsLayer = new GraphicsLayer(); map.add(filteredPointsLayer);
    const linesLayer = new GraphicsLayer(); map.add(linesLayer);
    const locLayer = new GraphicsLayer(); map.add(locLayer);
    const viirsLayer = new GraphicsLayer(); map.add(viirsLayer);

    /* Simboli con halo/drop shadow */
    const symWater    = new SimpleMarkerSymbol({ color:[0,112,255,0.85], outline:{ color:[255,255,255,0.9], width:1.5 }, size:6 });
    const symFiltered = new SimpleMarkerSymbol({ color:[255,64,64,0.9],  outline:{ color:[255,255,255,0.9], width:1.5 }, size:7 });
    const symLocation = new SimpleMarkerSymbol({ color:[0,200,0,0.9],   outline:{ color:[255,255,255,0.9], width:2.5 }, size:10 });
    const symLine     = new SimpleLineSymbol({ color:[255,0,0,0.7], width:2 });
    const symFire     = { type:"simple-marker", size:7, color:[255,64,0,0.9], outline:{ color:[255,255,255,0.9], width:1.5 } };

    /* ====== UI: colonna sinistra (Zoom + Ricentra + Reset Nord + Ricerca icona) ====== */
    // Ricentra: torna al centro iniziale mantenendo lo zoom attuale
    const recenterBtn = document.createElement("button");
    recenterBtn.className = "esri-btn-icon esri-widget esri-widget--button";
    recenterBtn.title = "Ricen tra"; recenterBtn.textContent = "‚¶ø";
    recenterBtn.onclick = ()=> view.goTo({ center: initialCenter, zoom: view.zoom }).catch(()=>{});

    // Reset Nord: rotazione = 0¬∞
    const resetNorthBtn = document.createElement("button");
    resetNorthBtn.className = "esri-btn-icon esri-widget esri-widget--button";
    resetNorthBtn.title = "Resetta Nord"; resetNorthBtn.textContent = "üß≠";
    resetNorthBtn.onclick = ()=> { view.rotation = 0; };

    // Ricerca come icona (lente) in Expand
    const searchWidget = new Search({ view, includeDefaultSources: true });
    const searchExpand = new Expand({
      view,
      content: searchWidget,
      expandIconClass: "esri-icon-search",
      collapseIconClass: "esri-icon-search"
    });

    // Posizionamento in colonna sotto i controlli di zoom (lato sinistro)
    // L'ordine: Zoom (+/-) [di default], poi Ricentra, poi Reset Nord, poi Lente (Expand)
    view.ui.add(recenterBtn,   { position:"top-left", index:1 });
    view.ui.add(resetNorthBtn, { position:"top-left", index:2 });
    view.ui.add(searchExpand,  { position:"top-left", index:3 });

    /* ====== UI: GPS rimane in alto a destra ====== */
    const gpsBtn = document.createElement("button");
    gpsBtn.className = "esri-btn-icon esri-widget esri-widget--button";
    gpsBtn.title = "Localizar-me"; gpsBtn.textContent = "üìç";
    gpsBtn.onclick = ()=> navigator.geolocation?.getCurrentPosition(
      p=>{
        const pt = new Point({ longitude:p.coords.longitude, latitude:p.coords.latitude });
        view.goTo({ target:pt, zoom:14 }).catch(()=>{});
        locLayer.removeAll();
        locLayer.add(new Graphic({ geometry:pt, symbol:symLocation }));
        showToast("Localiza√ß√£o definida");
        findNearest(pt);
      },
      ()=> showToast("N√£o foi poss√≠vel obter a localiza√ß√£o."),
      { enableHighAccuracy:true, maximumAge:30000, timeout:10000 }
    );
    view.ui.add(gpsBtn, { position:"top-right", index:0 });

    /* ====== Pannelli, toast, loader ====== */
    const infoPanel = document.getElementById("infoPanel");
    const infoContent = document.getElementById("infoContent");
    const toggleInfo = document.getElementById("toggleInfo");
    const filterPanel = document.getElementById("filterPanel");
    const toggleFilter = document.getElementById("toggleFilter");
    const distritoFilter = document.getElementById("distritoFilter");
    const concelhoFilter = document.getElementById("concelhoFilter");
    const applyFilter = document.getElementById("applyFilter");
    const resetFilter = document.getElementById("resetFilter");
    const btnFireHeader = document.getElementById("btnFireHeader");
    const toast = document.getElementById("toast");
    const loadingMsg = document.getElementById("loadingMessage");

    let loaderCount = 0;
    function showLoader(txt){ if(txt) document.getElementById("loadingBox").textContent = txt; loaderCount++; loadingMsg.style.display="grid"; }
    function hideLoader(force=false){ loaderCount = force ? 0 : Math.max(0, loaderCount-1); if(loaderCount===0) loadingMsg.style.display="none"; }
    function showToast(msg, ms=1800){ toast.textContent = msg; toast.style.display = "block"; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display = "none", ms); }

    const allPoints = [];
    const distritoConcelho = {};
    const uniqueDistritos = new Set();
    let spatialGrid = {};
    let nearest = [];

    /* ====== ICNF WFS ====== */
    const wfsUrl = "https://si.icnf.pt/wfs/pontos_agua?service=WFS&version=2.0.0&request=GetFeature&typeNames=pontos_agua&outputFormat=application/json&srsName=EPSG:4326";
    showLoader("A carregar dados‚Ä¶");
    fetch(wfsUrl, { credentials:"omit", cache:"no-store" })
      .then(r=>r.json())
      .then(gj=>{ if(!gj?.features) throw new Error("GeoJSON vazio."); ingestWater(gj.features); })
      .catch(e=> { console.warn(e); showToast("Falha ao carregar pontos de √°gua."); })
      .finally(()=> hideLoader(true));

    function ingestWater(features){
      for(const f of features){
        const c = f.geometry && f.geometry.coordinates;
        if(!c) continue;
        const pt = new Point({ longitude:+c[0], latitude:+c[1] });
        const attrs = f.properties || {};
        const g = new Graphic({
          geometry:pt, attributes:attrs, symbol:symWater,
          popupTemplate:{
            title: attrs.nome || attrs.tipologia || "Ponto de √°gua",
            content:(ev)=>{
              const geom=ev.graphic.geometry, a=ev.graphic.attributes||{};
              const lat = Number(geom.latitude).toFixed(6), lon = Number(geom.longitude).toFixed(6);
              const wazeUrl  = "https://waze.com/ul?ll="+lat+"%2C"+lon+"&navigate=yes&zoom=17";
              const gmapsUrl = "https://www.google.com/maps/dir/?api=1&destination="+lat+","+lon;
              return buildTable(a) +
                     "<div style='margin-top:8px; display:flex; gap:10px; align-items:center;'>"+
                     "<a href='"+wazeUrl+"' target='_blank' rel='noopener noreferrer'>Waze</a>"+
                     "<a href='"+gmapsUrl+"' target='_blank' rel='noopener noreferrer'>Google</a>"+
                     "</div>";
            }
          }
        });
        allPoints.push(g); waterLayer.add(g);

        const d = attrs.distrito || "Desconhecido";
        const ccl = attrs.concelho || "Desconhecido";
        uniqueDistritos.add(d);
        if(!distritoConcelho[d]) distritoConcelho[d] = new Set();
        distritoConcelho[d].add(ccl);
      }
      for(const d of Array.from(uniqueDistritos).sort()){ distritoFilter.appendChild(new Option(d,d)); }
      if(view.center) findNearest(view.center);
    }

    function buildTable(attrs){
      const rows = Object.entries(attrs||{}).filter(([k,v])=> v!=null && v!=="").sort((a,b)=> a[0].localeCompare(b[0]));
      let html="<table class='info-table'><tbody>";
      for(const [k,v] of rows){
        const label=k.replace(/_/g," ").replace(/\b\w/g, l=>l.toUpperCase());
        html += "<tr><th>"+label+"</th><td>"+v+"</td></tr>";
      }
      html += "</tbody></table>";
      return html;
    }

    /* ====== Filtri ====== */
    distritoFilter.addEventListener("change", function(){
      concelhoFilter.innerHTML = '<option value="">Todos os concelhos</option>';
      const s = distritoConcelho[this.value];
      if(s) Array.from(s).sort().forEach(c=> concelhoFilter.appendChild(new Option(c,c)));
    });
    applyFilter.addEventListener("click", ()=>{
      filteredPointsLayer.removeAll();
      const d = distritoFilter.value, c = concelhoFilter.value;
      for(const g of allPoints){
        const a=g.attributes||{};
        if((!d || a.distrito===d) && (!c || a.concelho===c)){
          const gg = g.clone(); gg.symbol = symFiltered; filteredPointsLayer.add(gg);
        }
      }
      const tgt = filteredPointsLayer.graphics.length ? filteredPointsLayer.graphics.items : waterLayer.graphics.items;
      fitToGraphics(tgt, 60); if(view.center) findNearest(view.center);
    });
    resetFilter.addEventListener("click", ()=>{
      distritoFilter.value=""; concelhoFilter.innerHTML = '<option value="">Todos os concelhos</option>';
      filteredPointsLayer.removeAll(); fitToGraphics(waterLayer.graphics.items, 60); if(view.center) findNearest(view.center);
    });

    function fitToGraphics(graphics, padding=40){
      if(!graphics || !graphics.length) return;
      let xmin=Infinity, ymin=Infinity, xmax=-Infinity, ymax=-Infinity;
      for(const g of graphics){
        const geom=g.geometry; if(!geom) continue;
        const x = geom.longitude ?? geom.x, y = geom.latitude ?? geom.y;
        if(typeof x!=='number' || typeof y!=='number') continue;
        if(x<xmin) xmin=x; if(y<ymin) ymin=y; if(x>xmax) xmax=x; if(y>ymax) ymax=y;
      }
      if(!isFinite(xmin)||!isFinite(ymin)||!isFinite(ymax)) return;
      const ext = new Extent({ xmin, ymin, xmax, ymax, spatialReference:{ wkid:4326 } });
      view.goTo({ target:ext, padding }).catch(()=>{});
    }

    /* ====== Nearest ====== */
    function buildSpatialGrid(points, gridSize=0.5){
      spatialGrid={};
      for(const p of points){
        const lon=p.geometry.longitude, lat=p.geometry.latitude;
        const gx=Math.floor(lon/gridSize), gy=Math.floor(lat/gridSize);
        const key=`${gx},${gy}`; if(!spatialGrid[key]) spatialGrid[key]=[];
        spatialGrid[key].push(p);
      }
    }
    function haversineMeters(a,b){
      const R=6371000, toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.latitude-a.latitude), dLon=toRad(b.longitude-a.longitude);
      const lat1=toRad(a.latitude), lat2=toRad(b.latitude);
      const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return Math.round(2*R*Math.asin(Math.sqrt(s)));
    }
    function findNearest(pt){
      if(!allPoints.length || !pt) return;
      linesLayer.removeAll();
      if(Object.keys(spatialGrid).length===0) buildSpatialGrid(allPoints);

      const active = filteredPointsLayer.graphics.length ? filteredPointsLayer.graphics.items : allPoints;
      const gridSize=0.5, gx=Math.floor(pt.longitude/gridSize), gy=Math.floor(pt.latitude/gridSize);
      let candidates=[];
      for(let x=gx-2; x<=gx+2; x++){
        for(let y=gy-2; y<=gy+2; y++){
          const key=`${x},${y}`; const cell=spatialGrid[key]; if(!cell) continue;
          for(const g of cell) if(active.includes(g)){
            candidates.push({ feature:g, distance:haversineMeters(pt, g.geometry) });
          }
        }
      }
      if(candidates.length<4) candidates = active.map(g=>({ feature:g, distance:haversineMeters(pt, g.geometry) }));
      nearest = candidates.filter(o=> o.distance<=10000).sort((a,b)=>a.distance-b.distance).slice(0,4);
      for(const item of nearest){
        const line=new Polyline({ paths:[[pt.longitude,pt.latitude],[item.feature.geometry.longitude,item.feature.geometry.latitude]], spatialReference:{ wkid:4326 } });
        linesLayer.add(new Graphic({ geometry:line, symbol:symLine }));
      }
      renderInfo();
    }
    function renderInfo(){
      let html="<ul style='margin:0; padding-left:16px; font-size:12px;'>";
      if(!nearest.length){ html+="<li>Nenhum ponto encontrado (‚â§ 10 km)</li>"; }
      else {
        for(const o of nearest){
          const a=o.feature.attributes||{}; const name=a.nomenome||a.nome||"Sem nome";
          const type=a.tipologia?(" ("+a.tipologia+")"):"";
          html+="<li>"+name+type+" ‚Äî "+o.distance+" m</li>";
        }
      }
      html+="</ul>";
      infoContent.innerHTML=html;
    }
    view.on("pointer-move", (e)=>{ const pt=view.toMap({x:e.x,y:e.y}); if(pt) findNearest(pt); });
    view.on("pointer-down", (e)=>{ const pt=view.toMap({x:e.x,y:e.y}); if(pt) findNearest(pt); });
    view.on("drag", ()=>{ if(view.center) findNearest(view.center.clone()); });
    view.when(()=>{ if(view.center) findNearest(view.center); });

    /* ====== VIIRS ultimi 2 giorni + bounding box Europa ====== */
    const VIIRS_QUERY_BASE =
      "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query";
    function viirsGeoJsonUrl(){
      const d = new Date(); d.setUTCDate(d.getUTCDate() - 2);
      const yyyy = d.getUTCFullYear(), mm = String(d.getUTCMonth()+1).padStart(2,"0"), dd = String(d.getUTCDate()).padStart(2,"0");
      const dateStr = `${yyyy}-${mm}-${dd}`;
      const bbox = { xmin:-12, ymin:34, xmax:32, ymax:72, spatialReference:{ wkid:4326 } };
      const qs = new URLSearchParams({
        where: `acq_date >= DATE '${dateStr}'`,
        outFields: "*",
        outSR: "4326",
        f: "geojson",
        geometry: JSON.stringify(bbox),
        geometryType: "esriGeometryEnvelope",
        spatialRel: "esriSpatialRelIntersects",
        inSR: "4326"
      }).toString();
      return `${VIIRS_QUERY_BASE}?${qs}`;
    }

    async function loadVIIRSAll(){
      try{
        showLoader("A carregar inc√™ndios‚Ä¶");
        const res = await fetch(viirsGeoJsonUrl(), { method:"GET", mode:"cors", credentials:"omit", cache:"no-store" });
        const gj = await res.json();
        drawVIIRS(gj.features||[]);
        showToast("Inc√™ndios VIIRS: ON");
      } catch(err){
        console.error("VIIRS fetch error:", err);
        showToast("Falha ao carregar inc√™ndios");
        clearVIIRS();
        btnFireHeader.setAttribute("aria-pressed","false");
      } finally { hideLoader(); }
    }
    function drawVIIRS(features){
      viirsLayer.removeAll();
      for(const f of features){
        const c = f.geometry && f.geometry.coordinates; if(!c) continue;
        const attrs = f.properties || {};
        viirsLayer.add(new Graphic({
          geometry: { type:"point", longitude:+c[0], latitude:+c[1] },
          attributes: attrs,
          symbol: symFire,
          popupTemplate: { title:"VIIRS hotspot", content: viirsPopupContent(attrs) }
        }));
      }
    }
    function clearVIIRS(){ viirsLayer.removeAll(); }

    // Parser data/ora + contenuto popup VIIRS
    function viirsDate(a){
      const dkey = pickKey(a, /^(acq[_]?date)$/i);
      const tkey = pickKey(a, /^(acq[_]?time)$/i);
      let hh = 0, mm = 0;
      if (tkey != null && a[tkey] != null) {
        const rawT = String(a[tkey]).trim().replace(":", "");
        if (/^\d{1,4}$/.test(rawT)) {
          const n = parseInt(rawT, 10);
          if (n > 2400) { hh = Math.floor(n/60)%24; mm = n%60; }
          else { hh = Math.floor(n/100)%24; mm = n%100; }
        }
      }
      if (dkey != null) {
        const v = a[dkey];
        if (typeof v === "number") {
          const ms = v > 1e12 ? v : v*1000; const d = new Date(ms);
          if (!isNaN(d)) { d.setUTCHours(hh, mm, 0, 0); return d; }
        } else if (typeof v === "string") {
          const s = v.trim();
          if (/^\d{10}$/.test(s) || /^\d{13}$/.test(s)) {
            const num = Number(s); const ms = s.length===13 ? num : num*1000;
            const d = new Date(ms); if (!isNaN(d)) { d.setUTCHours(hh, mm, 0, 0); return d; }
          }
          const p = Date.parse(s); if (!isNaN(p)) { const d = new Date(p); if (tkey!=null) d.setUTCHours(hh,mm,0,0); return d; }
          const m = s.match(/^(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
          if (m) { const Y=+m[1], M=+m[2], D=+m[3]; const d = new Date(Date.UTC(Y,(M||1)-1,D||1,hh,mm,0)); if(!isNaN(d)) return d; }
        }
      }
      const dtkey = pickKey(a, /(datetime|date)/i);
      if (dtkey) {
        const raw = a[dtkey];
        if (typeof raw === "number") { const ms = raw>1e12?raw:raw*1000; const d=new Date(ms); if(!isNaN(d)) return d; }
        else if (typeof raw === "string") { const s=raw.trim(); const p=Date.parse(s); if(!isNaN(p)) return new Date(p); }
      }
      return null;
    }
    function viirsPopupContent(a){
      const dt = viirsDate(a);
      const dtTxt = dt ? new Intl.DateTimeFormat(navigator.language||"pt-PT",{ dateStyle:"medium", timeStyle:"short" }).format(dt) : "‚Äî";
      const frp = a.frp!=null ? Number(a.frp).toFixed(1)+" MW" : "‚Äî";
      const bright = a.brightness!=null ? Number(a.brightness).toFixed(0)+" K"
                    : (a.brightness_ti4!=null ? Number(a.brightness_ti4).toFixed(0)+" K" : "‚Äî");
      const dn = a.daynight || a.DayNight || "‚Äî";
      const conf = a.confidence!=null ? a.confidence
                  : (a.confidence_day!=null ? a.confidence_day
                  : (a.confidence_night!=null ? a.confidence_night : "‚Äî"));
      return `
        <table class="info-table"><tbody>
          <tr><th>Data/ora</th><td>${dtTxt}</td></tr>
          <tr><th>FRP</th><td>${frp}</td></tr>
          <tr><th>Brightness</th><td>${bright}</td></tr>
          <tr><th>Day/Night</th><td>${dn}</td></tr>
          <tr><th>Confidence</th><td>${conf}</td></tr>
        </tbody></table>
      `;
    }
    function pickKey(obj, re){ for(const k in obj){ if(re.test(k)) return k; } return null; }

    // Toggle fiamma
    btnFireHeader.addEventListener("click", ()=>{
      const on = btnFireHeader.getAttribute("aria-pressed")==="true";
      if(on){ btnFireHeader.setAttribute("aria-pressed","false"); clearVIIRS(); showToast("Inc√™ndios VIIRS: OFF"); }
      else { btnFireHeader.setAttribute("aria-pressed","true"); loadVIIRSAll(); }
    });

    /* Collapsible pannelli */
    function togglePanel(panel, btn){
      const collapsed = panel.dataset.state==="collapsed";
      if(collapsed){ panel.dataset.state="expanded"; panel.style.maxHeight="50%"; btn.textContent = (btn.id==="toggleInfo" ? "üìã" : "‚öôÔ∏è"); }
      else { panel.dataset.state="collapsed"; panel.style.maxHeight="24px"; btn.textContent="‚ñ∂"; }
    }
    toggleInfo.addEventListener("click", ()=> togglePanel(infoPanel, toggleInfo));
    toggleFilter.addEventListener("click", ()=> togglePanel(filterPanel, toggleFilter));

    const small = Math.max(window.innerWidth, window.innerHeight) < 700;
    if(small){ togglePanel(infoPanel, toggleInfo); togglePanel(filterPanel, toggleFilter); }

  });
  </script>
</body>
</html>