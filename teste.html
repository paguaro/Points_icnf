<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<title>Pontos de √°gua + VIIRS (filtro tempo)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
<style>
  html,body,#viewDiv{height:100%;width:100%;margin:0;padding:0;-webkit-text-size-adjust:100%}
  /* Barra icone (GPS + FUOCO + filtro) */
  .iconbar{position:absolute;top:10px;right:10px;z-index:5;display:flex;gap:6px;align-items:center}
  .iconbtn{background:transparent;border:none;cursor:pointer;padding:6px;min-width:36px;font-size:22px;line-height:1;border-radius:8px}
  /* FUOCO nudo: spento=grigio, acceso=colore naturale */
  #btnFire{filter:grayscale(1) brightness(.8);transition:filter .15s ease,transform .08s ease}
  #btnFire[aria-pressed="true"]{filter:none}
  .iconbtn:active{transform:scale(.96)}
  /* Select compatto per filtro temporale */
  #fireAge{display:none;appearance:none;font-size:12px;padding:6px 8px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
  #error{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#d32f2f;color:#fff;padding:8px 12px;border-radius:6px;display:none;z-index:10;font-size:13px}
</style>
</head>
<body>
<div id="viewDiv"></div>

<!-- Barra icone a destra: GPS + FUOCO + filtro temporale -->
<div class="iconbar">
  <button id="btnGPS" class="iconbtn" title="Localizar-me">üìç</button>
  <button id="btnFire" class="iconbtn" title="Inc√™ndios (VIIRS)" aria-pressed="false">üî•</button>
  <select id="fireAge" title="Intervalo temporal">
    <option value="24">24h</option>
    <option value="48">48h</option>
    <option value="72" selected>72h</option>
    <option value="168">7d</option>
    <option value="all">Tudo</option>
  </select>
</div>

<div id="error"></div>

<script src="https://js.arcgis.com/4.33/"></script>
<script>
require([
  "esri/Map","esri/views/MapView",
  "esri/layers/GraphicsLayer","esri/Graphic",
  "esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
  "esri/widgets/Search","esri/widgets/BasemapGallery","esri/widgets/Expand",
  "esri/request"
], function(Map,MapView,GraphicsLayer,Graphic,Point,SimpleMarkerSymbol,Search,BasemapGallery,Expand,esriRequest){

  /* ===== MAPPA & UI BASE ===== */
  const map = new Map({ basemap: "streets-navigation-vector" });
  const view = new MapView({ container:"viewDiv", map, center:[-8,39.5], zoom:7 });

  const search = new Search({ view });
  view.ui.add(search, { position:"top-right", index:1 });

  const bg = new BasemapGallery({ view });
  view.ui.add(new Expand({ view, content:bg, expandIconClass:"esri-icon-basemap" }), "bottom-right");

  /* ===== PULSANTI (GPS + FUOCO + FILTRO) ===== */
  const btnGPS = document.getElementById("btnGPS");
  const btnFire = document.getElementById("btnFire");
  const fireAge = document.getElementById("fireAge");

  btnGPS.addEventListener("click", ()=>{
    if(!navigator.geolocation) return showError("Geolocaliza√ß√£o n√£o suportada.");
    navigator.geolocation.getCurrentPosition(
      p=>{
        const pt = new Point({ longitude:p.coords.longitude, latitude:p.coords.latitude });
        view.goTo({ target:pt, zoom:14 }).catch(()=>{});
        locLayer.removeAll();
        locLayer.add(new Graphic({
          geometry:pt,
          symbol:new SimpleMarkerSymbol({ color:[0,200,0,0.9], outline:{color:[255,255,255],width:2}, size:10 })
        }));
      },
      ()=> showError("N√£o foi poss√≠vel obter a localiza√ß√£o."),
      { enableHighAccuracy:true, maximumAge:30000, timeout:10000 }
    );
  });

  btnFire.addEventListener("click", ()=>{
    const on = btnFire.getAttribute("aria-pressed")==="true";
    if(on){
      btnFire.setAttribute("aria-pressed","false");
      fireAge.style.display = "none";
      clearVIIRS();
    } else {
      btnFire.setAttribute("aria-pressed","true");
      fireAge.style.display = "inline-block";
      loadVIIRS(currentAgeHours());
    }
  });

  fireAge.addEventListener("change", ()=>{
    if(btnFire.getAttribute("aria-pressed")==="true"){
      loadVIIRS(currentAgeHours());
    }
  });

  function currentAgeHours(){
    const v = fireAge.value;
    return v==="all" ? null : Number(v);
  }

  /* ===== LAYERS ===== */
  const waterLayer = new GraphicsLayer(); map.add(waterLayer);
  const viirsLayer = new GraphicsLayer(); map.add(viirsLayer);
  const locLayer   = new GraphicsLayer(); map.add(locLayer);

  /* ===== PUNTI ACQUA (ICNF WFS) ===== */
  const wfsUrl = "https://si.icnf.pt/wfs/pontos_agua?service=WFS&version=2.0.0&request=GetFeature&typeNames=pontos_agua&outputFormat=application/json&srsName=EPSG:4326";

  esriRequest(wfsUrl, { responseType:"json" })
    .then(r=>{
      const gj = r.data; if(!gj?.features) return;
      for(const f of gj.features){
        const c = f.geometry?.coordinates; if(!c) continue;
        const pt = new Point({ longitude:+c[0], latitude:+c[1] });
        const sym = new SimpleMarkerSymbol({ color:[0,112,255,0.85], outline:{ color:[80,220,255], width:1 }, size:5 });
        waterLayer.add(new Graphic({ geometry:pt, attributes:f.properties||{}, symbol:sym }));
      }
    })
    .catch(()=> showError("Falha ao carregar pontos de √°gua."));

  /* ===== VIIRS (fetch GeoJSON senza credenziali) ===== */
  const VIIRS_QUERY_BASE =
    "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0/query";

  function viirsGeoJsonUrl(){
    const qs = new URLSearchParams({
      where: "1=1",           // filtriamo lato client (robusto rispetto ai nomi dei campi)
      outFields: "*",
      outSR: "4326",
      f: "geojson"
    }).toString();
    return `${VIIRS_QUERY_BASE}?${qs}`;
  }

  async function loadVIIRS(maxAgeHours){
    try{
      const res = await fetch(viirsGeoJsonUrl(), {
        method: "GET",
        mode: "cors",
        credentials: "omit",   // <- fondamentale per evitare l‚Äôerrore CORS
        cache: "no-store"
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const gj = await res.json();
      if(!gj || !Array.isArray(gj.features)) throw new Error("GeoJSON non valido");

      // Filtro temporale lato client
      const now = Date.now();
      const feats = (maxAgeHours==null) ? gj.features : gj.features.filter(f=>{
        const dt = featureDateUTC(f.properties || {});
        if(!dt) return false;
        const ageH = (now - dt.getTime()) / 36e5;
        return ageH >= 0 && ageH <= maxAgeHours;
      });

      drawVIIRS(feats);
    } catch(err){
      console.error("VIIRS fetch error:", err);
      showError("Falha ao carregar dados de inc√™ndios (VIIRS).");
      clearVIIRS();
      btnFire.setAttribute("aria-pressed","false");
      fireAge.style.display = "none";
    }
  }

  function clearVIIRS(){ viirsLayer.removeAll(); }

  function drawVIIRS(features){
    viirsLayer.removeAll();
    const sym = { type:"simple-marker", size:6, color:[255,64,0,0.9], outline:null }; // icona ‚Äúnuda‚Äù
    for(const f of features){
      const c = f.geometry && f.geometry.coordinates;
      if(!c) continue;
      viirsLayer.add(new Graphic({
        geometry: { type:"point", longitude:+c[0], latitude:+c[1] },
        attributes: f.properties || {},
        symbol: sym,
        popupTemplate: null
      }));
    }
  }

  /* ===== Heuristica robusta: trova la data/ora del punto VIIRS =====
     Tenta in ordine:
     - acq_date (+ acq_time)
     - qualsiasi chiave che contenga 'datetime' o 'date'
  */
  function featureDateUTC(props){
    // 1) acq_date (+ acq_time)
    const acqDateKey = pickKey(props, /^(acq[_]?date)$/i);
    if(acqDateKey){
      try{
        const dstr = String(props[acqDateKey]).trim(); // tipicamente "YYYY-MM-DD"
        const [y,m,d] = dstr.split(/\D+/).map(Number);
        let hh = 0, mm = 0;
        const acqTimeKey = pickKey(props, /^(acq[_]?time)$/i);
        if(acqTimeKey){
          // es: 1436 -> 14:36 ; alcuni dataset forniscono minuti da inizio giorno -> proviamo HHMM
          const t = String(props[acqTimeKey]).padStart(4,"0");
          hh = Number(t.slice(0,2))||0;
          mm = Number(t.slice(2,4))||0;
        }
        // Costruiamo UTC
        return new Date(Date.UTC(y, (m||1)-1, d||1, hh, mm, 0));
      }catch(_){ /* fallback sotto */ }
    }
    // 2) datetime / date generici
    const dtKey = pickKey(props, /(datetime|date)/i);
    if(dtKey){
      const raw = props[dtKey];
      // Proviamo parse ISO o numerico epoch ms/sec
      if(typeof raw === "string"){
        const parsed = Date.parse(raw);
        if(!isNaN(parsed)) return new Date(parsed);
      } else if(typeof raw === "number"){
        // se √® in secondi, porta a ms
        const ms = raw > 1e12 ? raw : raw*1000;
        return new Date(ms);
      }
    }
    return null;
  }

  function pickKey(obj, regex){
    for(const k in obj){ if(regex.test(k)) return k; }
    return null;
  }

  /* ===== Messaggi di errore ===== */
  const errorBox = document.getElementById("error");
  function showError(msg){
    errorBox.textContent = msg;
    errorBox.style.display = "block";
    clearTimeout(showError._t);
    showError._t = setTimeout(()=> errorBox.style.display="none", 5000);
  }
});
</script>
</body>
</html>
