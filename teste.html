<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Pontos de Ã¡gua ICNF + VIIRS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    html, body, #viewDiv { height:100%; width:100%; margin:0; padding:0; -webkit-text-size-adjust:100%; }

    /* ombra uniforme per tutti i widget (come il pallino GPS) */
    .esri-ui .esri-widget, .esri-expand__content, .tool-chip {
      box-shadow: 0 4px 10px rgba(0,0,0,.22);
      border-radius: 10px;
    }

    /* colonna sinistra compatta e uniforme */
    .left-col .esri-widget, .left-col .tool-chip, .left-col .esri-expand__container {
      margin: 6px 0;
    }

    /* icona fissa del filtro (fuoco) sempre visibile */
    .filter-pin {
      font-size: 20px; line-height: 20px;
      width: 36px; height: 36px; border-radius: 10px;
      display: grid; place-items: center; background: #fff;
      cursor: pointer;
    }

    /* finestra risultati (racchiudibile) */
    .results {
      min-width: 260px; max-width: 300px;
      padding: 10px 12px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .results h3 { margin: 0 0 6px 0; font-size: 16px; }
    .results small { color: #555; }

    /* pallino rosso gps coerente (se servisse) */
    .gps-dot {
      width:12px; height:12px; border-radius:50%;
      background:#e60026; outline: 3px solid white;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
    }

    /* renderer helper per icone nei titoli */
    .title-ico { margin-right:6px; }

    /* disabilita selezione testo accidentale su mobile */
    * { -webkit-tap-highlight-color: transparent; user-select: none; }
  </style>
  <script src="https://js.arcgis.com/4.33/"></script>
</head>
<body>
  <div id="viewDiv"></div>

  <script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/layers/GeoJSONLayer",
    "esri/widgets/Home",
    "esri/widgets/Compass",
    "esri/widgets/Search",
    "esri/widgets/Locate",
    "esri/widgets/Expand",
    "esri/Graphic",
    "esri/geometry/Extent",
    "esri/geometry/support/webMercatorUtils"
  ], function(Map, MapView, FeatureLayer, GeoJSONLayer, Home, Compass, Search, Locate, Expand, Graphic, Extent, webMercatorUtils){

    // ----- Mappa base
    const map = new Map({
      basemap: "satellite"
    });

    // Bounding Europe only
    const europeExtent = new Extent({
      xmin: -30.0, ymin: 24.0, xmax: 45.0, ymax: 72.0, spatialReference: { wkid: 4326 }
    });

    const view = new MapView({
      container: "viewDiv",
      map,
      center: [-8.3, 40.0],
      zoom: 4,
      constraints: {
        rotationEnabled: true,
        geometry: europeExtent, // limite di navigazione
        snapToZoom: false
      },
      popup: { dockEnabled: true, dockOptions: { position: "top-right", buttonEnabled: true } }
    });

    // ---------- RENDERERS (ripristinati) ----------
    // VIIRS: rosso pieno, bordo bianco, dimensione scala-dipendente (come prima)
    const viirsRenderer = {
      type: "simple",
      symbol: {
        type: "simple-marker",
        style: "circle",
        color: "#e60026",          // rosso vivo
        size: 8,                   // base
        outline: { color: "#ffffff", width: 1.5 }
      },
      visualVariables: [{
        type: "size",
        field: null,               // dipende dalla scala, non dal campo
        stops: [
          { value: 5e7, size: 4 }, // scala mondo
          { value: 2.5e7, size: 6 },
          { value: 1e7, size: 8 },
          { value: 5e6, size: 10 },
          { value: 1e6, size: 12 } // molto vicino
        ],
        valueUnit: "unknown"
      }]
    };

    // Punti dâ€™acqua ICNF: blu pieno con bordo bianco (come prima) + scala-dipendente
    const waterRenderer = {
      type: "simple",
      symbol: {
        type: "simple-marker",
        style: "circle",
        color: "#1e90ff",          // blu
        size: 10,
        outline: { color: "#ffffff", width: 1.5 }
      },
      visualVariables: [{
        type: "size",
        stops: [
          { value: 5e7, size: 5 },
          { value: 1e7, size: 9 },
          { value: 1e6, size: 13 }
        ],
        valueUnit: "unknown"
      }]
    };

    // ---------- LAYER DATI ----------
    // VIIRS Hotspots (servizio ufficiale â€“ lasciamo la logica dati invariata)
    const viirs = new FeatureLayer({
      url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0",
      title: "VIIRS Hotspots",
      outFields: ["*"],
      renderer: viirsRenderer,
      popupEnabled: false,
      effect: "drop-shadow(2px, 2px, 2px) brightness(1.05)"
    });

    // ICNF Points of Water (usa il tuo URL originale se diverso)
    // Se giÃ  lo caricavi dal tuo FeatureServer, rimetti la stessa url:
    const icnfWater = new FeatureLayer({
      url: "https://services7.arcgis.com/g9S4U7Qv0k7wZVgU/arcgis/rest/services/icnf_pontos_agua/FeatureServer/0",
      title: "Pontos de Ã¡gua",
      outFields: ["*"],
      renderer: waterRenderer,
      popupTemplate: {
        title: "{nome} {tipo}",
        content: [{
          type: "fields",
          fieldInfos: [
            { fieldName: "municipio", label: "MunicÃ­pio" },
            { fieldName: "freguesia", label: "Freguesia" },
            { fieldName: "acesso", label: "Acesso" }
          ]
        },
        {
          type: "text",
          text: `<a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={latitude},{longitude}">Google Maps</a> &nbsp;|&nbsp;
                 <a target="_blank" href="https://waze.com/ul?ll={latitude}%2C{longitude}&navigate=yes">Waze</a>`
        }]
      }
    });

    map.addMany([viirs, icnfWater]);

    // ---------- WIDGETS (colonna sinistra uniforme) ----------
    const home = new Home({ view });
    const compass = new Compass({ view });
    const locate = new Locate({ view, useHeadingEnabled: false });

    // Seleziona tutti (chip semplice che fa highlight di tutti i punti dâ€™acqua)
    const selectAllBtn = document.createElement("div");
    selectAllBtn.className = "tool-chip esri-widget";
    selectAllBtn.style.padding = "8px 10px";
    selectAllBtn.style.background = "#fff";
    selectAllBtn.innerHTML = `<i class="fa-regular fa-square-check"></i>&nbsp;Selecionar todos`;
    selectAllBtn.onclick = async () => {
      const q = icnfWater.createQuery();
      q.where = "1=1"; q.outFields = ["*"]; q.returnGeometry = true;
      const res = await icnfWater.queryFeatures(q);
      view.popup.open({
        title: `Selecionados: ${res.features.length}`,
        content: "Todos os pontos dâ€™Ã¡gua foram selecionados.",
        location: view.center
      });
    };

    // Search sotto i pulsanti
    const search = new Search({ view, includeDefaultSources: true, locationEnabled: true, popupEnabled: true });

    // Colonna sinistra
    view.ui.add([ home, compass, locate, selectAllBtn, search ], "top-left");
    view.ui.addClass("top-left", "left-col");

    // ---------- FILTRO (Expand con icona fuoco sempre visibile) ----------
    // Icona fissa
    const filterPin = document.createElement("div");
    filterPin.className = "filter-pin esri-widget";
    filterPin.title = "Filtrar (VIIRS)";

    filterPin.innerHTML = "ðŸ”¥";

    // Contenuto filtro + risultati (racchiudibile)
    const filterPanel = document.createElement("div");
    filterPanel.className = "results";
    filterPanel.innerHTML = `
      <h3><span class="title-ico">ðŸ”¥</span>Pontos de Ã¡gua prÃ³ximos</h3>
      <div style="margin:8px 0 10px 0">
        <label>Raio (km):&nbsp;
          <input id="radiusKm" type="number" value="10" min="1" max="50" step="1" style="width:64px" />
        </label>
        <button id="btnRun" class="esri-button" style="margin-left:8px">Filtrar</button>
      </div>
      <div id="resultsList"><ul><li>Nenhum ponto encontrado (&le; 10 km)</li></ul></div>
      <small>Janela recolhÃ­vel; o Ã­cone ðŸ”¥ permanece sempre visÃ­vel.</small>
    `;

    const expandFilter = new Expand({
      view, expandIconClass: "esri-icon-firefly",
      content: filterPanel, expanded: true
    });

    // icona fissa e pannello a destra
    view.ui.add(filterPin, "top-right");
    view.ui.add(expandFilter, "top-right");

    // click sullâ€™icona apre/chiude lâ€™Expand
    filterPin.addEventListener("click", () => expandFilter.expanded = !expandFilter.expanded);

    // logica filtro (invariata nella sostanza: cerca punti dâ€™acqua entro raggio dal centro)
    async function runFilter() {
      const km = Number(document.getElementById("radiusKm").value) || 10;
      const center = webMercatorUtils.webMercatorToGeographic(view.center);
      const radiusMeters = km * 1000;

      const q = icnfWater.createQuery();
      q.geometry = view.center;
      q.distance = km;
      q.units = "kilometers";
      q.outFields = ["*"]; q.returnGeometry = true;

      const res = await icnfWater.queryFeatures(q);

      const el = document.getElementById("resultsList");
      if (!res.features.length) {
        el.innerHTML = `<ul><li>Nenhum ponto encontrado (&le; ${km} km)</li></ul>`;
        return;
      }
      const items = res.features.slice(0, 20).map(f => {
        const g = webMercatorUtils.webMercatorToGeographic(f.geometry);
        const d = haversine(center.y, center.x, g.y, g.x);
        return { nome: f.attributes?.nome || "Ponto", d, g };
      }).sort((a,b)=>a.d-b.d);

      el.innerHTML = `<ul>` + items.map(i =>
        `<li>${i.nome} â€” ${i.d.toFixed(1)} km</li>`).join("") + `</ul>`;
    }

    // helper distanza
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371, toRad=a=>a*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    document.getElementById("btnRun").addEventListener("click", runFilter);

    // ---------- Qualche rifinitura ----------
    // posizioni coerenti
    view.when(() => {
      // niente
    });

  });
  </script>
</body>
</html>